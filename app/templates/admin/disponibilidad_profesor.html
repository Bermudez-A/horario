{% extends 'base.html' %}

{% block title %}Disponibilidad del Profesor - Generador de Horarios{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <h1 class="mt-4 mb-4"><i class="fas fa-calendar-alt me-2"></i>Disponibilidad del Profesor</h1>
    
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-info-circle me-1 text-primary"></i>Información de Disponibilidad
                    </div>
                    <div>
                        {% if profesor_seleccionado %}
                        <span class="badge bg-primary fs-6">{{ profesor_seleccionado.get_nombre_completo() }}</span>
                        <input type="hidden" id="profesorIdActual" value="{{ profesor_seleccionado.id }}">
                        {% else %}
                        <span class="badge bg-danger fs-6">Error: Profesor no identificado</span>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <p>En este panel puede marcar las horas en las que el profesor <strong>NO</strong> estará disponible para impartir clases.</p>
                    <p>Haga clic en una celda del horario para cambiar su disponibilidad. Las celdas <span class="badge bg-danger">rojas</span> indican no disponibilidad.</p>
                    <div class="d-flex mt-3 justify-content-center">
                        <div class="me-4 d-flex align-items-center">
                            <div class="disponibilidad-muestra disponible me-2"></div> Disponible
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="disponibilidad-muestra no-disponible me-2"></div> No disponible
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <div>
                <i class="fas fa-table me-1 text-primary"></i>
                Horario de Disponibilidad
            </div>
            <button id="btnRefrescarDisponibilidad" class="btn btn-outline-primary btn-sm" title="Recargar datos">
                <i class="fas fa-sync-alt me-1"></i>Actualizar
            </button>
        </div>
        <div class="card-body">
            <div id="disponibilidadContainer">
                <!-- El horario se renderizará aquí por JavaScript -->
                <div class="text-center py-5" id="initial-loading-placeholder">
                    <p class="lead text-muted">Inicializando horario...</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mt-3 text-end">
        <a href="{{ url_for('admin.profesores') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i>Volver a la lista de profesores
        </a>
    </div>
</div>

<!-- Modal para editar disponibilidad -->
<div class="modal fade" id="disponibilidadModal" tabindex="-1" aria-labelledby="disponibilidadModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="disponibilidadModalLabel"><i class="fas fa-edit me-2"></i>Editar Disponibilidad</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="disponibilidadForm">
                    <input type="hidden" id="modalDia" name="dia">
                    <input type="hidden" id="modalHora" name="hora">
                    <input type="hidden" id="modalProfesorId" name="profesor_id">
                    
                    <div class="alert alert-info small">
                        <p class="mb-1"><strong>Profesor:</strong> <span id="modalProfesorNombre"></span></p>
                        <p class="mb-1"><strong>Día:</strong> <span id="modalDiaTexto"></span></p>
                        <p class="mb-0"><strong>Hora:</strong> <span id="modalHoraTexto"></span></p>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Disponibilidad:</label>
                        <div class="form-check form-switch form-check-reverse mb-2">
                            <input class="form-check-input" type="radio" name="disponible" id="disponibleSi" value="true" checked>
                            <label class="form-check-label" for="disponibleSi">
                               <span class="badge bg-success">Disponible</span>
                            </label>
                        </div>
                        <div class="form-check form-switch form-check-reverse">
                            <input class="form-check-input" type="radio" name="disponible" id="disponibleNo" value="false">
                            <label class="form-check-label" for="disponibleNo">
                                <span class="badge bg-danger">No disponible</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3" id="motivoContainer" style="display:none;">
                        <label for="motivo" class="form-label fw-bold">Motivo (Obligatorio si no está disponible):</label>
                        <textarea class="form-control" id="motivo" name="motivo" rows="3" placeholder="Indique el motivo de la no disponibilidad..."></textarea>
                        <div class="invalid-feedback">
                            Por favor, indique un motivo.
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnGuardarDisponibilidad">
                    <span class="spinner-border spinner-border-sm d-none me-1" id="spinnerGuardar" role="status" aria-hidden="true"></span>
                    Guardar Cambios
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block styles %}
<style>
    .disponibilidad-muestra {
        width: 20px;
        height: 20px;
        display: inline-block;
        border: 1px solid #ccc;
        margin-right: 5px;
        border-radius: 3px;
        vertical-align: middle;
    }
    .disponible {
        background-color: #d1e7dd; /* Verde claro */
    }
    .no-disponible {
        background-color: #f8d7da; /* Rojo claro */
    }
    .tabla-disponibilidad {
        width: 100%;
        border-collapse: separate; /* Separar bordes para redondeo */
        border-spacing: 0;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem; /* Bootstrap's default */
        overflow: hidden; /* Para que el redondeo afecte a las celdas */
    }
    .tabla-disponibilidad th, 
    .tabla-disponibilidad td {
        border: 1px solid #dee2e6;
        padding: 0.75rem; /* Más padding */
        text-align: center;
        vertical-align: middle; /* Centrar verticalmente */
    }
    .tabla-disponibilidad th {
        background-color: #f8f9fa;
        font-weight: 600; /* Un poco más grueso */
    }
    .tabla-disponibilidad td {
         min-width: 80px; /* Ancho mínimo para celdas */
    }
    .celda-disponibilidad {
        cursor: pointer;
        height: 60px; /* Un poco más altas */
        transition: background-color 0.2s ease-in-out, transform 0.1s ease;
        font-size: 0.9rem; /* Texto un poco más pequeño si hay motivo */
        position: relative; /* Para posible contenido absoluto */
    }
    .celda-disponibilidad:hover {
        opacity: 0.85;
        transform: scale(1.02); /* Ligero efecto zoom */
    }
    .celda-disponibilidad.disponible {
        background-color: #d1e7dd;
        color: #0f5132;
    }
    .celda-disponibilidad.no-disponible {
        background-color: #f8d7da;
        color: #842029;
        font-weight: 500;
    }
     /* Estilo para el motivo dentro de la celda (opcional) */
    .celda-disponibilidad .motivo-texto {
        display: block;
        font-size: 0.75rem;
        margin-top: 4px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 100%;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // console.log("¡Script de disponibilidad iniciado!"); 

    // Variables globales
    let diaActual = null;
    let horaActual = null;
    let profesorIdActual = null;
    let nombreProfesorActual = '';
    let disponibilidadesCargadas = []; // Almacena los datos cargados
    
    // Mapeo de días (solo para mostrar)
    const diasSemana = {
        'lunes': 'Lunes',
        'martes': 'Martes',
        'miercoles': 'Miércoles',
        'jueves': 'Jueves',
        'viernes': 'Viernes'
    };
    
    // Mapeo de horas del sistema a horas de clase
    const horasClaseMap = {
        '1': '1ª hora',
        '2': '2ª hora',
        '3': '3ª hora',
        '4': '4ª hora',
        '5': '5ª hora',
        '6': '6ª hora',
        '7': '7ª hora'
    };
    
    // Mapeo inverso para convertir hora de clase a hora del sistema
    const horasSistemaMap = {
        '1': '1',
        '2': '2',
        '3': '3',
        '4': '4',
        '5': '5',
        '6': '6',
        '7': '7'
    };
    
    // Función para obtener parámetros de la URL
    function obtenerParametroURL(nombre) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(nombre);
    }
    
    // Función para mostrar mensajes
    function mostrarMensaje(tipo, mensaje) {
        console.log(`[Mensaje ${tipo}]: ${mensaje}`); // Log adicional
        const alertElement = document.createElement('div');
        alertElement.className = `alert alert-${tipo} alert-dismissible fade show`;
        alertElement.innerHTML = `
            ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        const container = document.querySelector('.container-fluid');
        if (container) {
             // Insertar después del H1
             const titleElement = container.querySelector('h1');
             if (titleElement) {
                 titleElement.parentNode.insertBefore(alertElement, titleElement.nextSibling);
             } else {
                 container.insertBefore(alertElement, container.firstChild);
             }
        } else {
             console.error("No se encontró el contenedor principal para mostrar mensajes.");
        }
        
        // Auto-eliminar después de 5 segundos
        setTimeout(() => {
             if(alertElement.parentNode) { // Comprobar si todavía existe
                 alertElement.classList.remove('show');
                 // Esperar a que termine la transición de desvanecimiento
                 alertElement.addEventListener('transitionend', () => alertElement.remove());
             }
        }, 5000);
    }

    // Renderizar la tabla de disponibilidad (con o sin datos)
    function renderizarDisponibilidad(data = []) {
        console.log("[Renderizar] Iniciando renderizado con datos:", data);
        
        // Guardar los datos para referencia futura
        disponibilidadesCargadas = data;
        
        // Obtener el nombre del profesor
        nombreProfesorActual = document.querySelector('.badge.bg-primary')?.textContent || 'Profesor';
        console.log(`[Renderizar] Nombre del profesor: ${nombreProfesorActual}`);
        
        const container = document.getElementById('disponibilidadContainer');
        if (!container) {
            console.error("[Renderizar] ERROR CRÍTICO: Contenedor 'disponibilidadContainer' no encontrado.");
            mostrarMensaje('danger', 'Error interno: no se encontró el contenedor del horario.');
            return;
        }
        
        console.log("[Renderizar] Generando HTML para la tabla...");
        // Generar HTML para la tabla
        let html = `
            <h4 class="mb-3">Disponibilidad de ${nombreProfesorActual}</h4>
            <div class="table-responsive">
                <table class="tabla-disponibilidad table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Hora</th>
                            <th>Lunes</th>
                            <th>Martes</th>
                            <th>Miércoles</th>
                            <th>Jueves</th>
                            <th>Viernes</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        // Generar las horas usando número de clase (1ª hora hasta 7ª hora)
        for (let i = 1; i <= 7; i++) {
            const horaNumero = `${i}ª hora`;
            const horaSistema = horasSistemaMap[i.toString()]; // Convertir a string para buscar en el mapa
            
            html += `<tr>`;
            html += `<td>${horaNumero}</td>`;
            
            // Para cada día (lunes a viernes)
            const dias = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes'];
            
            for (const dia of dias) {
                // Buscar en los datos si existe esta hora y día
                const disponibilidad = disponibilidadesCargadas.find(d => d.dia === dia && d.hora === horaSistema);
                
                const disponible = disponibilidad ? disponibilidad.disponible : true;
                const motivo = disponibilidad && disponibilidad.motivo ? disponibilidad.motivo : '';
                
                html += `
                    <td class="celda-disponibilidad ${disponible ? 'disponible' : 'no-disponible'}" 
                        data-dia="${dia}" 
                        data-hora="${horaSistema}" 
                        data-disponible="${disponible}" 
                        data-motivo="${motivo}" 
                        title="${!disponible ? `No disponible: ${motivo}` : 'Disponible'}"
                    >
                     ${!disponible ? `<span class="motivo-texto" title="${motivo}">${motivo}</span>` : ''} <!-- Mostrar motivo si no está disponible -->
                    </td>
                `;
            }
            
            html += `</tr>`;
        }
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
        
        console.log("[Renderizar] HTML generado. Intentando actualizar el DOM...");
        // Actualizar el contenedor
        try {
            container.innerHTML = html;
            console.log("[Renderizar] Actualización del DOM completada."); // <-- Log importante
        } catch (error) {
            console.error("[Renderizar] ERROR al actualizar el innerHTML del contenedor:", error);
            container.innerHTML = '<div class="alert alert-danger">Error al renderizar el horario.</div>';
            mostrarMensaje('danger', 'Error interno al mostrar el horario.');
            return; // Detener si no se puede renderizar
        }
        
        console.log("[Renderizar] Añadiendo event listeners a las celdas...");
        // Agregar event listeners a las celdas
        document.querySelectorAll('.celda-disponibilidad').forEach(celda => {
            celda.addEventListener('click', function() {
                const dia = this.dataset.dia;
                const hora = this.dataset.hora;
                const disponible = this.dataset.disponible === 'true';
                const motivo = this.dataset.motivo || '';
                
                mostrarModalDisponibilidad(dia, hora, disponible, motivo);
            });
        });
        console.log("[Renderizar] Finalizado.");
    }
    
    // Cargar disponibilidad del profesor
    function cargarDisponibilidad(profesorId) {
        console.log(`[Cargar] Iniciando carga para profesor ID: ${profesorId}`);
        
        if (!profesorId) {
            console.error("[Cargar] ID de profesor no válido.");
            mostrarMensaje('warning', 'No se ha especificado un profesor válido.');
            renderizarDisponibilidad([]); 
            return;
        }
        
        profesorIdActual = profesorId;
        
        // Construir URL con codificación segura
        const url = `/schedules/get_disponibilidad/${encodeURIComponent(profesorId)}`;
        console.log(`[Cargar] Consultando URL: ${url}`);
        
        // Hacer petición a la API
        fetch(url)
            .then(response => {
                console.log(`[Cargar] Respuesta recibida (Estado: ${response.status})`);
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(`Error del servidor: ${response.status} - ${text || 'Sin detalles'}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log("[Cargar] Datos JSON recibidos:", data);
                
                let disponibilidades = [];
                
                if (data.success === true) {
                    console.log("[Cargar] Respuesta exitosa, procesando disponibilidades...");
                    
                    // Crear un array con todas las combinaciones posibles de día y hora
                    const dias = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes'];
                    const horas = Array.from({length: 7}, (_, i) => (i + 1).toString());
                    
                    // Inicializar todas las horas como disponibles
                    dias.forEach(dia => {
                        horas.forEach(hora => {
                            disponibilidades.push({
                                dia: dia,
                                hora: hora,
                                disponible: true,
                                motivo: ''
                            });
                        });
                    });
                    
                    // Actualizar con los datos recibidos del servidor
                    if (data.disponibilidad) {
                        Object.entries(data.disponibilidad).forEach(([key, value]) => {
                            const [dia, hora] = key.split('_');
                            const horaNumero = hora.split(':')[0]; // Extraer solo el número de la hora
                            
                            const index = disponibilidades.findIndex(d => 
                                d.dia === dia && d.hora === horaNumero
                            );
                            
                            if (index !== -1) {
                                disponibilidades[index].disponible = value.disponible;
                                disponibilidades[index].motivo = value.motivo || '';
                            }
                        });
                    }
                    
                    console.log("[Cargar] Disponibilidades procesadas:", disponibilidades);
                } else {
                    console.warn("[Cargar] Formato de respuesta inesperado", data);
                    mostrarMensaje('warning', 'No se encontraron datos de disponibilidad previos. Se muestra un horario vacío.');
                }
                
                console.log("[Cargar] Llamando a renderizarDisponibilidad...");
                renderizarDisponibilidad(disponibilidades);
            })
            .catch(error => {
                console.error("[Cargar] ERROR en fetch o procesamiento:", error);
                mostrarMensaje('danger', `Error al cargar la disponibilidad: ${error.message}`);
                renderizarDisponibilidad([]); 
            });
    }
    
    // Mostrar modal para editar disponibilidad
    function mostrarModalDisponibilidad(dia, hora, disponible, motivo) {
        try {
            console.log(`[Modal] Abriendo para día: ${dia}, hora: ${hora}, disponible: ${disponible}`);
            
            // Verificar que el modal existe en el DOM
            const modalElement = document.getElementById('disponibilidadModal');
            if (!modalElement) {
                console.error("[Modal] El elemento modal no se encuentra en el DOM");
                throw new Error("El formulario de disponibilidad no está disponible");
            }

            // Inicializar el modal si no está inicializado
            let modal = bootstrap.Modal.getInstance(modalElement);
            if (!modal) {
                modal = new bootstrap.Modal(modalElement);
                console.log("[Modal] Modal inicializado");
            }

            // Configurar los datos antes de mostrar el modal
            diaActual = dia;
            horaActual = hora;
            
            // Convertir hora del sistema a número de clase para mostrar en el modal
            const horaClase = horasClaseMap[hora] || hora;

            // Función para actualizar los elementos del modal
            function actualizarElementosModal() {
                // Verificar que todos los elementos necesarios existan
                const elementos = {
                    modalDia: modalElement.querySelector('#modalDia'),
                    modalHora: modalElement.querySelector('#modalHora'),
                    modalProfesorId: modalElement.querySelector('#modalProfesorId'),
                    modalDiaTexto: modalElement.querySelector('#modalDiaTexto'),
                    modalHoraTexto: modalElement.querySelector('#modalHoraTexto'),
                    modalProfesorNombre: modalElement.querySelector('#modalProfesorNombre'),
                    motivo: modalElement.querySelector('#motivo'),
                    motivoContainer: modalElement.querySelector('#motivoContainer'),
                    disponibleSi: modalElement.querySelector('#disponibleSi'),
                    disponibleNo: modalElement.querySelector('#disponibleNo')
                };
                
                // Verificar que todos los elementos existan
                for (const [nombre, elemento] of Object.entries(elementos)) {
                    if (!elemento) {
                        console.error(`[Modal] Elemento ${nombre} no encontrado en el DOM`);
                        throw new Error(`Elemento ${nombre} no encontrado en el DOM`);
                    }
                }
                
                // Llenar campos del modal
                elementos.modalDia.value = dia;
                elementos.modalHora.value = hora;
                elementos.modalProfesorId.value = profesorIdActual;
                elementos.modalDiaTexto.textContent = diasSemana[dia] || dia;
                elementos.modalHoraTexto.textContent = horaClase;
                elementos.modalProfesorNombre.textContent = nombreProfesorActual || 'Profesor';
                
                // Limpiar validación previa del motivo
                elementos.motivo.classList.remove('is-invalid');
                
                // Establecer estado de disponibilidad
                if (disponible) {
                    elementos.disponibleSi.checked = true;
                    elementos.disponibleNo.checked = false;
                    elementos.motivoContainer.style.display = 'none';
                    elementos.motivo.value = '';
                } else {
                    elementos.disponibleSi.checked = false;
                    elementos.disponibleNo.checked = true;
                    elementos.motivoContainer.style.display = 'block';
                    elementos.motivo.value = motivo || '';
                }
            }

            // Configurar el event listener para cuando el modal esté completamente mostrado
            const onShown = function() {
                try {
                    actualizarElementosModal();
                    modalElement.removeEventListener('shown.bs.modal', onShown);
                } catch (error) {
                    console.error("[Modal] ERROR al actualizar elementos:", error);
                    mostrarMensaje('danger', 'Error al mostrar el formulario de disponibilidad: ' + error.message);
                    modal.hide();
                }
            };

            // Agregar el event listener para cuando el modal se cierra
            const onHidden = function() {
                console.log("[Modal] Modal cerrado, recargando página...");
                setTimeout(() => {
                    window.location.reload();
                }, 100);
            };

            // Agregar los event listeners
            modalElement.addEventListener('shown.bs.modal', onShown, { once: true });
            modalElement.addEventListener('hidden.bs.modal', onHidden, { once: true });

            // Mostrar el modal
            modal.show();
            console.log("[Modal] Mostrado correctamente.");
        } catch (error) {
            console.error("[Modal] ERROR al mostrar el modal:", error);
            mostrarMensaje('danger', 'Error al mostrar el formulario de disponibilidad: ' + error.message);
        }
    }
    
    // Guardar disponibilidad
    function guardarDisponibilidad() {
        console.log("[Guardar] Iniciando proceso de guardado...");
        const dia = document.getElementById('modalDia').value; // 'lunes', 'martes', etc.
        const hora = document.getElementById('modalHora').value; // '8:00 - 9:00', etc.
        const profesorId = document.getElementById('modalProfesorId').value;
        const disponible = document.querySelector('input[name="disponible"]:checked').value === 'true';
        const motivoInput = document.getElementById('motivo');
        const motivo = motivoInput.value.trim();
        
        // Limpiar error previo
        motivoInput.classList.remove('is-invalid');

        // Validar si se requiere motivo
        if (!disponible && !motivo) {
             console.warn("[Guardar] Intento de guardar 'No disponible' sin motivo.");
            motivoInput.classList.add('is-invalid');
            return;
        }
        
        // Mostrar spinner
        console.log("[Guardar] Mostrando spinner...");
        const btnGuardar = document.getElementById('btnGuardarDisponibilidad');
        const spinner = document.getElementById('spinnerGuardar');
        spinner.classList.remove('d-none');
        btnGuardar.setAttribute('disabled', 'disabled');
        
        // Datos para enviar (dia y hora como strings)
        const dataToSend = {
            profesor_id: profesorId,
            dia: dia,
            hora: hora,
            disponible: disponible,
            motivo: disponible ? '' : motivo // Asegurar motivo vacío si está disponible
        };
        
        console.log("[Guardar] Enviando datos:", dataToSend);
        
        // Hacer petición a la API con la ruta correcta
        fetch('/schedules/availability/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify(dataToSend)
        })
        .then(response => {
             console.log(`[Guardar] Respuesta recibida (Estado: ${response.status})`);
            if (!response.ok) {
                // Intentar leer el cuerpo del error si existe
                return response.text().then(text => {
                     console.error(`[Guardar] Error en respuesta: ${response.status} - ${text}`);
                    throw new Error(`Error del servidor: ${response.status} - ${text || 'Sin detalles'}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log("[Guardar] Respuesta JSON del servidor:", data);
            
            if (data.success) {
                 console.log("[Guardar] Operación exitosa en el servidor.");
                // Cerrar modal
                try {
                    const modalElement = document.getElementById('disponibilidadModal');
                    const modal = bootstrap.Modal.getInstance(modalElement);
                    if (modal) {
                        modal.hide();
                        console.log("[Guardar] Modal cerrado.");
                    }
                } catch (e) {
                    console.warn("[Guardar] No se pudo obtener la instancia del modal para cerrarlo.", e);
                }
                
                // Mostrar mensaje de éxito
                mostrarMensaje('success', 'La disponibilidad ha sido actualizada correctamente.');
                
                // Recargar la página después de un breve retraso
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            } else {
                console.error("[Guardar] El servidor indicó un error:", data.message);
                throw new Error(data.message || 'Error desconocido al guardar la disponibilidad');
            }
        })
        .catch(error => {
            console.error("[Guardar] ERROR en fetch o procesamiento:", error);
            mostrarMensaje('danger', `Error al guardar la disponibilidad: ${error.message}`);
        })
        .finally(() => {
            // Ocultar spinner y habilitar botón
            spinner.classList.add('d-none');
            btnGuardar.removeAttribute('disabled');
        });
    }

    // Actualizar una celda específica en la tabla
    function actualizarCeldaDisponibilidad(dia, hora, disponible, motivo) {
        console.log(`[Actualizar Celda] Actualizando celda: ${dia}, ${hora}, disponible: ${disponible}`);
        
        // Encontrar la celda correspondiente
        const celda = document.querySelector(`.celda-disponibilidad[data-dia="${dia}"][data-hora="${hora}"]`);
        if (!celda) {
            console.error(`[Actualizar Celda] No se encontró la celda para ${dia}, ${hora}`);
            return;
        }
        
        // Actualizar clases y atributos
        celda.className = `celda-disponibilidad ${disponible ? 'disponible' : 'no-disponible'}`;
        celda.dataset.disponible = disponible;
        celda.dataset.motivo = motivo || '';
        
        // Actualizar contenido
        if (!disponible && motivo) {
            celda.innerHTML = `<span class="motivo-texto" title="${motivo}">${motivo}</span>`;
        } else {
            celda.innerHTML = '';
        }
        
        // Actualizar tooltip
        celda.title = !disponible ? `No disponible: ${motivo}` : 'Disponible';
        
        console.log("[Actualizar Celda] Celda actualizada correctamente");
    }

    // Inicializar al cargar la página
    document.addEventListener('DOMContentLoaded', function() {
        console.log("[Init] DOMContentLoaded disparado.");
        
        // Obtener el ID del profesor directamente del elemento oculto
        const profesorIdElemento = document.getElementById('profesorIdActual');
        if (profesorIdElemento && profesorIdElemento.value) {
            profesorIdActual = profesorIdElemento.value;
            console.log(`[Init] ID del profesor encontrado: ${profesorIdActual}`);
            
            // Cargar datos inmediatamente
            cargarDisponibilidad(profesorIdActual);
        } else {
            console.error("[Init] ERROR: No se encontró el ID del profesor en el elemento oculto #profesorIdActual.");
            mostrarMensaje('danger', 'Error: No se pudo identificar al profesor.');
            renderizarDisponibilidad([]);
        }
        
        // Event listener para el botón de refrescar
        document.getElementById('btnRefrescarDisponibilidad')?.addEventListener('click', function() {
            if (profesorIdActual) {
                console.log("[Botón Refrescar] Solicitando refresco de disponibilidad...");
                cargarDisponibilidad(profesorIdActual);
            } else {
                console.warn("[Botón Refrescar] No hay ID de profesor para refrescar.");
                mostrarMensaje('warning', 'No se ha especificado un profesor válido.');
            }
        });
        
        // Event listener para guardar disponibilidad
        document.getElementById('btnGuardarDisponibilidad')?.addEventListener('click', guardarDisponibilidad);
        
        // Event listener para cambiar visibilidad del campo motivo en el modal
        document.querySelectorAll('input[name="disponible"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const disponible = this.value === 'true';
                const motivoContainer = document.getElementById('motivoContainer');
                const motivoInput = document.getElementById('motivo');
                
                if (motivoContainer && motivoInput) {
                    motivoContainer.style.display = disponible ? 'none' : 'block';
                    if (disponible) {
                        motivoInput.classList.remove('is-invalid');
                    } else {
                        setTimeout(() => {
                            try {
                                motivoInput.focus();
                            } catch(e) {
                                console.warn("[Modal] Error al enfocar motivo:", e);
                            }
                        }, 100);
                    }
                }
            });
        });
        
        console.log("[Init] Inicialización completada.");
    });
    
    // Obtener el token CSRF
    function getCsrfToken() {
        return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
    }
</script>
{% endblock %}