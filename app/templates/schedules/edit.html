{% extends 'base.html' %}

{% block title %}Editar Horario - {{ clase.nombre }}{% endblock %}

{% block styles %}
<style>
    .horario-tabla td {
        height: 100px;
        position: relative;
        vertical-align: top;
        transition: all 0.2s;
    }
    
    .celda-vacia {
        background-color: #f8f9fa;
        cursor: pointer;
    }
    
    .celda-vacia:hover {
        background-color: #e9ecef;
    }
    
    .celda-con-clase {
        cursor: move;
    }
    
    .celda-con-clase:hover {
        opacity: 0.9;
    }
    
    .celda-actividad-comun {
        background-color: #fff9c4;
        cursor: not-allowed;
        position: relative;
        opacity: 0.8; /* Hacerlas un poco menos prominentes */
    }
    
    .asignatura-bloque {
        height: 100%;
        width: 100%;
        padding: 8px;
        color: white;
        border-radius: 4px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        font-size: 0.85rem; /* Ligeramente más pequeño */
    }
    
    .actividad-comun-bloque {
        height: 100%;
        width: 100%;
        padding: 10px;
        border-radius: 4px;
        display: flex;
        flex-direction: column;
        justify-content: center; /* Centrar contenido */
        align-items: center;
        text-align: center;
    }
    
    .actividad-comun-nombre {
        font-weight: bold;
        font-size: 0.9rem;
        color: #6c757d; /* Color más apagado */
    }
    
    .asignatura-nombre {
        font-weight: bold;
    }
    
    .profesor-nombre {
        font-size: 0.8rem;
        margin-top: 4px;
    }
    
    /* Estilos para el modal */
    .subject-option, .profesor-option {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
        padding: 8px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .subject-option:hover, .profesor-option:hover {
        background-color: #f1f3f5;
    }
    
    .subject-option.selected {
        border-color: #0d6efd;
        background-color: #e7f1ff;
        font-weight: bold;
    }
    
    .profesor-option.selected {
         border-color: #0d6efd;
         background-color: #0d6efd;
         color: white;
         font-weight: bold;
    }
    
    .subject-color {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        margin-right: 10px;
        display: inline-block;
        flex-shrink: 0; /* Evitar que se encoja */
    }
    
    /* Estilos para drag and drop */
    .dragging {
        opacity: 0.5;
        border: 2px dashed #0d6efd;
    }
    
    .drag-over {
        background-color: rgba(0, 123, 255, 0.1);
        border: 2px dashed #007bff;
        transform: scale(1.01); /* Ligeramente más grande */
    }
    
    .asignatura-item, .actividad-comun-item {
        cursor: grab;
        transition: all 0.2s;
    }
    
    .asignatura-item:hover, .actividad-comun-item:hover {
        background-color: #f8f9fa;
    }
    
    .asignatura-color, .actividad-color {
        width: 20px;
        height: 20px;
        border-radius: 4px;
    }
    
    .bloque-horario {
        padding: 5px;
        border-radius: 4px;
        color: white;
        text-align: center;
    }
    
    .miniatura-asignatura {
        width: 15px;
        height: 15px;
        border-radius: 50%;
        margin-right: 8px;
        display: inline-block;
    }
    
    .asignatura-card {
        margin-bottom: 10px;
        padding: 10px;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        cursor: grab;
        transition: all 0.2s;
    }
    
    .asignatura-card:hover {
        background-color: #f8f9fa;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .asignatura-card-header {
        font-weight: bold;
        display: flex;
        align-items: center;
        margin-bottom: 5px;
    }
    
    .asignatura-card-color {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        margin-right: 8px;
        display: inline-block;
    }

    /* Div para errores específicos del modal */
    #modal-error-container {
        min-height: 50px; /* Espacio reservado para errores */
    }

</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-edit me-2"></i>Editar Horario de {{ clase.nombre }}</h1>
        <div>
            <a href="{{ url_for('schedules.view_schedule', clase_id=clase.id) }}" class="btn btn-secondary">
                <i class="fas fa-eye me-1"></i> Ver Horario
            </a>
            <a href="{{ url_for('schedules.index') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Volver
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-3">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-book me-2"></i>Asignaturas Disponibles</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-light border-info small mb-3">
                        <i class="fas fa-info-circle me-1 text-info"></i>
                        Arrastra una asignatura al horario para añadirla.
                    </div>
                    
                    <div id="asignaturas-container">
                        {% for asignatura in asignaturas %}
                        <div class="asignatura-card" draggable="true" data-id="{{ asignatura.id }}">
                            <div class="asignatura-card-header">
                                <div class="asignatura-card-color" style="background-color: {{ asignatura.color }}"></div>
                                {{ asignatura.nombre }}
                            </div>
                            <div class="small text-muted">
                                <div>Horas: {{ asignatura.horas_semanales }}</div>
                                <div>Profesores: {{ asignatura.get_profesores_nombres()|join(', ') or 'Ninguno' }}</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-user-tie me-2"></i>Profesores</h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        {% for profesor in profesores %}
                        <div class="list-group-item px-2 py-1">
                            <div class="fw-bold small">{{ profesor.get_nombre_completo() }}</div>
                            <div class="text-muted" style="font-size: 0.75rem;">{{ profesor.get_asignaturas_nombres()|join(', ') or 'Ninguna' }}</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-9">
            <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Horario Semanal</h5>
                <div>
                            <button class="btn btn-sm btn-light" id="btn-clear-all" title="Eliminar todas las asignaciones">
                        <i class="fas fa-trash me-1"></i> Limpiar Todo
                    </button>
                            <button class="btn btn-sm btn-light ms-1" id="btn-generate" title="Intentar completar horario automáticamente">
                        <i class="fas fa-magic me-1"></i> Generar Automáticamente
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
                    <div class="alert alert-warning small mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        Las actividades comunes (celdas amarillas) son fijas y no se pueden modificar aquí.
                    </div>
                    <div class="alert alert-info small mb-3">
                        <i class="fas fa-hand-point-up me-2"></i>
                        Arrastra asignaturas de la izquierda o clases existentes para reorganizar. Haz clic en una celda para asignar/editar.
                    </div>
            <div class="table-responsive">
                <table class="table table-bordered horario-tabla">
                    <thead class="table-light">
                        <tr>
                            <th width="8%">Hora</th>
                            <th width="18.4%">Lunes</th>
                            <th width="18.4%">Martes</th>
                            <th width="18.4%">Miércoles</th>
                            <th width="18.4%">Jueves</th>
                            <th width="18.4%">Viernes</th>
                        </tr>
                    </thead>
                            <tbody id="horario-tbody">
                                {% for hora in range(1, 8) %} <!-- Asume 7 horas -->
                        <tr>
                                    <th class="text-center align-middle small">{{ hora }}° Hora</th>
                            
                            {% for dia in ['lunes', 'martes', 'miercoles', 'jueves', 'viernes'] %}
                                            {% set key = dia + '_' + (hora|string) %}
                                            {% set hora_data = horario[dia][hora-1] if horario and dia in horario and hora-1 < horario[dia]|length else None %}
                                            {% set actividad_comun = actividades_comunes.get(key) %}

                                            {% if actividad_comun %}
                                                <td class="celda-actividad-comun" data-dia="{{ dia }}" data-hora="{{ hora }}">
                                                    <div class="actividad-comun-bloque" 
                                                         data-color="{{ actividad_comun.color }}"
                                                         style="background-color: {{ actividad_comun.color }}; color: black;" 
                                                         title="{{ actividad_comun.titulo }}">
                                                        <div class="actividad-comun-nombre">
                                                            <i class="fas {{ actividad_comun.icono }} me-1"></i>
                                                            {{ actividad_comun.titulo }}
                                                        </div>
                                                    </div>
                                                </td>
                                            {% else %}
                                                <td class="celda-horario {% if hora_data %}celda-con-clase{% else %}celda-vacia{% endif %} {% if actividad_comun %}celda-actividad-comun{% endif %}"
                                data-dia="{{ dia }}"
                                data-hora="{{ hora }}"
                                data-asignatura-id="{{ hora_data.asignatura_id if hora_data else '' }}"
                                data-profesor-id="{{ hora_data.profesor_id if hora_data else '' }}"
                                data-clase-id="{{ clase.id }}">
                                                    {% if hora_data %}
                                                        <div class="asignatura-bloque" 
                                                             data-color="{{ hora_data.color }}"
                                                             style="background-color: {{ hora_data.color }}"
                                                             draggable="true"
                                                             data-asignatura-id="{{ hora_data.asignatura_id }}"
                                                             data-profesor-id="{{ hora_data.profesor_id }}"
                                                             title="{{ hora_data.asignatura }} - {{ hora_data.profesor }}">
                                    <div class="asignatura-nombre">
                                                                {% if hora_data.icono %}
                                                                <i class="fas {{ hora_data.icono }} me-1"></i>
                                        {% endif %}
                                                                {{ hora_data.asignatura }}
                                    </div>
                                    <div class="profesor-nombre">
                                                                {{ hora_data.profesor if hora_data.profesor else 'Sin asignar' }}
                                    </div>
                                </div>
                                {% endif %}
                            </td>
                                            {% endif %}
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </div>
    
<!-- Modal para asignar clase -->
<div class="modal fade" id="asignarModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-pencil-alt me-2"></i>Asignar/Editar Clase</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
        <div class="col-md-6">
                        <div class="alert alert-secondary py-2">
                            <strong>Día:</strong> <span id="modal-dia"></span><br>
                            <strong>Hora:</strong> <span id="modal-hora"></span>
                </div>
                                        </div>
                    <div class="col-md-6">
                        <!-- Contenedor para errores/info específicos del modal -->
                        <div id="modal-error-container">
                             <div class="alert alert-light border py-2" id="conflicto-info"> <!-- Contenedor para mensajes de conflicto -->
                                 <span class="text-muted small">Seleccione asignatura y profesor para verificar disponibilidad.</span>
                    </div>
                </div>
            </div>
        </div>
        
                <div class="row">
        <div class="col-md-6">
                        <h6><i class="fas fa-book me-1"></i> Selecciona Asignatura</h6>
                        <div id="asignaturas-list" class="list-group mb-3" style="max-height: 250px; overflow-y: auto;">
                            {% for asignatura in asignaturas %}
                            <a href="#" class="list-group-item list-group-item-action subject-option" data-id="{{ asignatura.id }}" data-color="{{ asignatura.color }}" data-icono="{{ asignatura.icono }}">
                                <div class="subject-color me-2" style="background-color: {{ asignatura.color }}"></div>
                                <div>
                                    <strong>{{ asignatura.nombre }}</strong>
                                    <div class="text-muted small">{{ asignatura.horas_semanales }}h/sem</div>
                </div>
                            </a>
                                {% endfor %}
                    </div>
                </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-user-tie me-1"></i> Selecciona Profesor</h6>
                        <div id="profesores-list" class="list-group mb-3" style="max-height: 250px; overflow-y: auto;">
                            <!-- Será llenado dinámicamente -->
                            <div class="alert alert-light border small">Seleccione una asignatura para ver profesores.</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-check mt-2">
                    <input class="form-check-input" type="checkbox" id="ajustar-otras-clases" checked>
                    <label class="form-check-label small" for="ajustar-otras-clases">
                        Ajustar automáticamente otras clases de esta asignatura con el mismo profesor (si es posible).
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-outline-danger me-auto" id="btn-eliminar" title="Eliminar esta asignación">
                    <i class="fas fa-trash-alt"></i> Eliminar
                </button>
                <button type="button" class="btn btn-primary" id="btn-guardar" disabled> <!-- Deshabilitado inicialmente -->
                     <span class="spinner-border spinner-border-sm d-none me-1" id="spinnerGuardar" role="status" aria-hidden="true"></span>
                    <i class="fas fa-save me-1"></i> Guardar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmación para intercambio -->
<div class="modal fade" id="swapModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="fas fa-exchange-alt me-2"></i>Intercambiar Clases</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>¿Deseas intercambiar estas dos clases?</p>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-info text-white small py-1">Origen</div>
                            <div class="card-body p-2 small">
                                <div><strong>Día:</strong> <span id="swap-origen-dia"></span></div>
                                <div><strong>Hora:</strong> <span id="swap-origen-hora"></span></div>
                                <div><strong>Asignatura:</strong> <span id="swap-origen-asignatura"></span></div>
                                <div><strong>Profesor:</strong> <span id="swap-origen-profesor"></span></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-success text-white small py-1">Destino</div>
                            <div class="card-body p-2 small">
                                <div><strong>Día:</strong> <span id="swap-destino-dia"></span></div>
                                <div><strong>Hora:</strong> <span id="swap-destino-hora"></span></div>
                                <div><strong>Asignatura:</strong> <span id="swap-destino-asignatura"></span></div>
                                <div><strong>Profesor:</strong> <span id="swap-destino-profesor"></span></div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Contenedor para errores de intercambio -->
                <div id="swap-error-container" class="mt-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btn-confirmar-swap">
                     <span class="spinner-border spinner-border-sm d-none me-1" id="spinnerSwap" role="status" aria-hidden="true"></span>
                    <i class="fas fa-check me-1"></i> Confirmar Intercambio
                 </button>
            </div>
        </div>
                    </div>
                </div>
                
<!-- Modal de confirmación para unir clases -->
<div class="modal fade" id="unirClasesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="fas fa-object-group me-2"></i>Unir Clases</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <span id="unir-clases-mensaje">El profesor ya está asignado a otra clase en este horario.</span>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-info text-white small py-1">Clase Actual</div>
                            <div class="card-body p-2 small">
                                <div><strong>Clase:</strong> <span id="unir-clases-actual"></span></div>
                                <div><strong>Asignatura:</strong> <span id="unir-clases-asignatura-actual"></span></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-success text-white small py-1">Clase Existente</div>
                            <div class="card-body p-2 small">
                                <div><strong>Clase:</strong> <span id="unir-clases-existente"></span></div>
                                <div><strong>Asignatura:</strong> <span id="unir-clases-asignatura-existente"></span></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <p>¿Deseas unir estas clases para que el profesor imparta la misma asignatura a ambos grupos simultáneamente?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btn-confirmar-unir">
                    <span class="spinner-border spinner-border-sm d-none me-1" id="spinnerUnir" role="status" aria-hidden="true"></span>
                    <i class="fas fa-check me-1"></i> Unir Clases
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Inicializando editor de horarios v2');
        
        let currentDia = null;
        let currentHora = null;
        let currentClaseId = {{ clase.id }};
        let selectedAsignaturaId = null;
        let selectedProfesorId = null;
        let asignaturasData = {};
        let profesoresData = {};
        let dragSourceElement = null;
        let dragSourceDia = null;
        let dragSourceHora = null;
        
        // Inicializar datos de asignaturas y profesores (simplificado para ejemplo)
        try {
        {% for asignatura in asignaturas %}
        asignaturasData[{{ asignatura.id }}] = {
                nombre: {{ asignatura.nombre | tojson }},
            color: "{{ asignatura.color }}",
            icono: "{{ asignatura.icono or '' }}",
            profesores: [
                {% for profesor_id in asignatura.get_profesores_ids() %}
                {{ profesor_id }},
                {% endfor %}
            ]
        };
        {% endfor %}
        
        {% for profesor in profesores %}
        profesoresData[{{ profesor.id }}] = {
                nombre: {{ profesor.get_nombre_completo() | tojson }},
            asignaturas: [
                {% for asignatura_id in profesor.get_asignaturas_ids() %}
                {{ asignatura_id }},
                {% endfor %}
            ]
        };
        {% endfor %}
            console.log("Datos inicializados:", { asignaturasData, profesoresData });
        } catch(e) {
            console.error("Error inicializando datos JS desde Jinja:", e);
            mostrarAlerta("Error interno al cargar datos iniciales. La funcionalidad puede verse afectada.", "danger");
        }

        
        // --- Event Listeners --- 
        
        // Celdas del horario (solo las que no son actividad común)
        document.querySelectorAll('.celda-horario:not(.celda-actividad-comun)').forEach(celda => {
            celda.addEventListener('click', openModal);
            celda.addEventListener('dragover', allowDrop);
            celda.addEventListener('dragleave', leaveDrop);
            celda.addEventListener('drop', drop);
        });
        
        // Asignaturas en la lista lateral
        document.querySelectorAll('#asignaturas-container .asignatura-card').forEach(card => {
            card.addEventListener('dragstart', dragAsignatura);
        });
        
        // Bloques de asignatura ya colocados en el horario
        document.querySelectorAll('#horario-tbody .asignatura-bloque').forEach(bloque => {
            bloque.addEventListener('dragstart', drag);
        });
        
        // Opciones de asignatura en el modal
        document.querySelectorAll('.subject-option').forEach(option => {
            option.addEventListener('click', (e) => {
                e.preventDefault(); // Prevenir comportamiento de enlace
                selectAsignatura(e);
            });
        });
        
        // Botones principales
        const btnGuardar = document.getElementById('btn-guardar');
        if (btnGuardar) btnGuardar.addEventListener('click', guardarAsignacion);
        
        const btnEliminar = document.getElementById('btn-eliminar');
        if (btnEliminar) btnEliminar.addEventListener('click', eliminarAsignacion);
        
        const btnClearAll = document.getElementById('btn-clear-all');
        if (btnClearAll) btnClearAll.addEventListener('click', confirmarLimpiarTodo);
        
        const btnGenerate = document.getElementById('btn-generate');
        if (btnGenerate) btnGenerate.addEventListener('click', confirmarGenerarAutomatico);
        
        const btnConfirmarSwap = document.getElementById('btn-confirmar-swap');
        if (btnConfirmarSwap) btnConfirmarSwap.addEventListener('click', confirmarIntercambio);
        
        // --- Funciones Drag and Drop --- 
        
        function allowDrop(ev) {
            ev.preventDefault();
            if (ev.currentTarget.classList.contains('celda-horario') && !ev.currentTarget.classList.contains('celda-actividad-comun')) {
                ev.currentTarget.classList.add('drag-over');
            }
        }
        
        function leaveDrop(ev) {
            ev.currentTarget.classList.remove('drag-over');
        }
        
        function drag(ev) {
            console.log('D&D: Iniciando arrastre de bloque existente');
            const asignaturaBloque = ev.target.closest('.asignatura-bloque');
            if (!asignaturaBloque) {
                 console.warn("D&D: No se encontró .asignatura-bloque");
                 ev.preventDefault(); // Prevenir arrastre si no se encuentra
                 return;
            }
            
            dragSourceElement = asignaturaBloque;
            const celda = asignaturaBloque.closest('.celda-horario');
            dragSourceDia = celda.dataset.dia;
            dragSourceHora = celda.dataset.hora;
            
            try {
                const data = JSON.stringify({
                    type: 'existing_block',
                    asignaturaId: asignaturaBloque.dataset.asignaturaId,
                    profesorId: asignaturaBloque.dataset.profesorId,
                    origen: { dia: dragSourceDia, hora: dragSourceHora }
                });
                ev.dataTransfer.setData('text/plain', data);
                ev.dataTransfer.effectAllowed = "move";
                console.log("D&D: Datos establecidos para bloque existente:", data);
                // Aplicar estilo de arrastre un poco después para que se vea
                 setTimeout(() => asignaturaBloque.classList.add('dragging'), 0);
            } catch (error) {
                console.error('D&D: Error en drag start:', error);
            }
        }
        
        function dragAsignatura(ev) {
            console.log('D&D: Iniciando arrastre de nueva asignatura');
            const card = ev.target.closest('.asignatura-card');
            if (!card) {
                 console.warn("D&D: No se encontró .asignatura-card");
                 ev.preventDefault();
                 return;
             }
            dragSourceElement = card; // Para posible feedback visual
            
            try {
                 const data = JSON.stringify({
                    type: 'new_subject',
                    asignaturaId: card.dataset.id
                });
                ev.dataTransfer.setData('text/plain', data);
                ev.dataTransfer.effectAllowed = "copy";
                 console.log("D&D: Datos establecidos para nueva asignatura:", data);
                // Aplicar estilo de arrastre
                 setTimeout(() => card.classList.add('dragging'), 0);
            } catch (error) {
                console.error('D&D: Error en dragAsignatura start:', error);
            }
        }
        
        function drop(ev) {
            console.log('D&D: Drop detectado');
            ev.preventDefault();
            const targetCelda = ev.currentTarget;
            targetCelda.classList.remove('drag-over');
            
            // Limpiar estilo de arrastre del origen si existe
             if (dragSourceElement) {
                 dragSourceElement.classList.remove('dragging');
             }
            
            const targetDia = targetCelda.dataset.dia;
            const targetHora = targetCelda.dataset.hora;
            
            // No permitir drop en celdas con actividad común
            if (targetCelda.classList.contains('celda-actividad-comun')) {
                console.warn('D&D: Intento de drop en actividad común. No permitido.');
                dragSourceElement = null;
                return;
            }
            
            try {
                const dataTransfer = ev.dataTransfer.getData('text/plain');
                if (!dataTransfer) {
                     console.error("D&D: No se obtuvieron datos en el drop.");
                     dragSourceElement = null;
                return;
            }
                console.log('D&D: Datos transferidos:', dataTransfer);
                const data = JSON.parse(dataTransfer);
                
                const celdaOcupada = targetCelda.classList.contains('celda-con-clase');
                const bloqueExistente = data.type === 'existing_block';
                const nuevaAsignatura = data.type === 'new_subject';
                
                console.log(`D&D: Tipo=${data.type}, Celda Ocupada=${celdaOcupada}`);

                // --- Lógica de Drop --- 

                // 1. Arrastrando bloque existente a celda vacía (MOVER)
                if (bloqueExistente && !celdaOcupada) {
                    console.log("D&D: Acción = MOVER");
                    moverClase(data.origen.dia, data.origen.hora, targetDia, targetHora);
                }
                // 2. Arrastrando bloque existente a celda ocupada (INTERCAMBIAR)
                else if (bloqueExistente && celdaOcupada) {
                     // Evitar intercambiar consigo mismo
                     if (data.origen.dia === targetDia && data.origen.hora === targetHora) {
                         console.log("D&D: Arrastrado sobre sí mismo, no hacer nada.");
                     } else {
                         console.log("D&D: Acción = INTERCAMBIAR");
                         mostrarModalIntercambio(data, targetCelda);
                     }
                }
                // 3. Arrastrando nueva asignatura a celda vacía (ASIGNAR NUEVO)
                else if (nuevaAsignatura && !celdaOcupada) {
                    console.log("D&D: Acción = ASIGNAR NUEVO");
                    openModalForNewAsignatura(data.asignaturaId, targetDia, targetHora);
                }
                // 4. Arrastrando nueva asignatura a celda ocupada (REEMPLAZAR - abrir modal preseleccionado)
                else if (nuevaAsignatura && celdaOcupada) {
                    console.log("D&D: Acción = REEMPLAZAR (abrir modal)");
                    openModalForNewAsignatura(data.asignaturaId, targetDia, targetHora);
                }
                 else {
                     console.warn("D&D: Condición de drop no manejada.");
                 }
                
            } catch (error) {
                console.error('D&D: Error procesando datos durante drop:', error);
                 mostrarAlerta("Error al procesar la acción de arrastrar.", "danger");
            }
            finally {
                 // Resetear origen del drag independientemente del resultado
                 dragSourceElement = null;
                 dragSourceDia = null;
                 dragSourceHora = null;
             }
        }
        
        // --- Funciones Modales y API --- 

        function mostrarModalIntercambio(data, targetCelda) {
            console.log("[Swap Modal] Abriendo modal de intercambio...");
            const origenDia = data.origen.dia;
            const origenHora = data.origen.hora;
            const origenCelda = document.querySelector(`.celda-horario[data-dia="${origenDia}"][data-hora="${origenHora}"]`);
            
            if (!origenCelda) {
                console.error("[Swap Modal] No se encontró la celda origen para el intercambio.");
                return;
            }
            
            const destinoDia = targetCelda.dataset.dia;
            const destinoHora = targetCelda.dataset.hora;
            
            // Preparar datos del Origen
            const origenAsignaturaId = origenCelda.dataset.asignaturaId;
            const origenProfesorId = origenCelda.dataset.profesorId;
            const origenAsignatura = asignaturasData[origenAsignaturaId]?.nombre || 'N/A';
            const origenProfesor = profesoresData[origenProfesorId]?.nombre || 'N/A';
            
            document.getElementById('swap-origen-dia').textContent = capitalize(origenDia);
            document.getElementById('swap-origen-hora').textContent = origenHora + "° hora";
            document.getElementById('swap-origen-asignatura').textContent = origenAsignatura;
            document.getElementById('swap-origen-profesor').textContent = origenProfesor;
            
            // Preparar datos del Destino
            const destinoAsignaturaId = targetCelda.dataset.asignaturaId;
            const destinoProfesorId = targetCelda.dataset.profesorId;
            const destinoAsignatura = asignaturasData[destinoAsignaturaId]?.nombre || 'N/A';
            const destinoProfesor = profesoresData[destinoProfesorId]?.nombre || 'N/A';
            
            document.getElementById('swap-destino-dia').textContent = capitalize(destinoDia);
            document.getElementById('swap-destino-hora').textContent = destinoHora + "° hora";
            document.getElementById('swap-destino-asignatura').textContent = destinoAsignatura;
            document.getElementById('swap-destino-profesor').textContent = destinoProfesor;
            
            // Guardar datos para la acción de confirmar
            window.swapData = {
                origen: { dia: origenDia, hora: origenHora, asignaturaId: origenAsignaturaId, profesorId: origenProfesorId },
                destino: { dia: destinoDia, hora: destinoHora, asignaturaId: destinoAsignaturaId, profesorId: destinoProfesorId }
            };
            
            // Limpiar errores previos y mostrar modal
            document.getElementById('swap-error-container').innerHTML = '';
            const swapModal = new bootstrap.Modal(document.getElementById('swapModal'));
            swapModal.show();
        }
        
        function confirmarIntercambio() {
            if (!window.swapData) return;
            console.log("[Swap] Confirmando intercambio:", window.swapData);
            
            const { origen, destino } = window.swapData;
            const btnConfirmar = document.getElementById('btn-confirmar-swap');
            const spinner = document.getElementById('spinnerSwap');
            const errorContainer = document.getElementById('swap-error-container');
            errorContainer.innerHTML = ''; // Limpiar errores previos
            
            btnConfirmar.disabled = true;
            spinner.classList.remove('d-none');

            // Verificar conflictos ANTES de intentar el intercambio
            Promise.all([
                checkConflictsAPI(destino.profesorId, origen.dia, origen.hora, currentClaseId),
                checkConflictsAPI(origen.profesorId, destino.dia, destino.hora, currentClaseId)
            ]).then(([conflictoDestEnOrigen, conflictoOrigenEnDestino]) => {
                let mensajesError = [];
                if (conflictoDestEnOrigen.conflict) {
                    mensajesError.push(`Origen (${origen.dia} ${origen.hora}): ${conflictoDestEnOrigen.message}`);
                }
                if (conflictoOrigenEnDestino.conflict) {
                    mensajesError.push(`Destino (${destino.dia} ${destino.hora}): ${conflictoOrigenEnDestino.message}`);
                }

                if (mensajesError.length > 0) {
                    console.error("[Swap] Conflictos detectados:", mensajesError);
                    errorContainer.innerHTML = `<div class="alert alert-danger small">${mensajesError.join('<br>')}</div>`;
                    throw new Error("Conflictos detectados"); // Detener la ejecución
                }

                // Si no hay conflictos, proceder con las actualizaciones
                console.log("[Swap] No hay conflictos, procediendo con las actualizaciones...");
                return Promise.all([
                    actualizarClaseEnServidor(destino.asignaturaId, destino.profesorId, origen.dia, origen.hora),
                    actualizarClaseEnServidor(origen.asignaturaId, origen.profesorId, destino.dia, destino.hora)
                ]);
            })
            .then(results => {
                console.log("[Swap] Resultados de actualización:", results);
                if (results.every(result => result.success)) {
                    console.log("[Swap] Actualización exitosa, actualizando UI...");
                    actualizarCelda(origen.dia, origen.hora, destino.asignaturaId, destino.profesorId);
                    actualizarCelda(destino.dia, destino.hora, origen.asignaturaId, origen.profesorId);
                    bootstrap.Modal.getInstance(document.getElementById('swapModal')).hide();
                    mostrarAlerta('Clases intercambiadas correctamente', 'success');
                } else {
                    const errores = results.filter(r => !r.success).map(r => r.message).join(', ');
                    console.error("[Swap] Error en la actualización del servidor:", errores);
                    errorContainer.innerHTML = `<div class="alert alert-danger small">Error al guardar: ${errores}</div>`;
                }
            })
            .catch(error => {
                console.error('[Swap] Error durante el intercambio:', error);
                if (error.message !== "Conflictos detectados") { // No mostrar doble alerta
                     errorContainer.innerHTML = `<div class="alert alert-danger small">Error inesperado: ${error.message}</div>`;
                }
            })
            .finally(() => {
                btnConfirmar.disabled = false;
                spinner.classList.add('d-none');
            });
        }
        
        function moverClase(origen_dia, origen_hora, destino_dia, destino_hora) {
            console.log(`[Mover] Moviendo clase de ${origen_dia}-${origen_hora} a ${destino_dia}-${destino_hora}`);
            const origenCelda = document.querySelector(`.celda-horario[data-dia="${origen_dia}"][data-hora="${origen_hora}"]`);
            const destinoCelda = document.querySelector(`.celda-horario[data-dia="${destino_dia}"][data-hora="${destino_hora}"]`);
            
            if (!origenCelda || !destinoCelda) return mostrarAlerta('Error interno: Celdas no encontradas.', 'danger');
            
            const asignaturaId = origenCelda.dataset.asignaturaId;
            const profesorId = origenCelda.dataset.profesorId;
            
            if (!asignaturaId || !profesorId) {
                console.error("[Mover] Datos incompletos en celda origen:", { asignaturaId, profesorId });
                return mostrarAlerta('Error: Datos incompletos en la celda de origen.', 'danger');
            }
            
            if (destinoCelda.classList.contains('celda-con-clase')) return mostrarAlerta('No se puede mover, el destino está ocupado.', 'warning');

            // Verificar conflictos en destino ANTES de mover
            checkConflictsAPI(profesorId, destino_dia, destino_hora, currentClaseId)
                .then(conflictoData => {
                    if (conflictoData.conflict) {
                        // Comprobar si el mensaje de error contiene alguna indicación de que el profesor está asignado en otra clase
                        const mensajeError = conflictoData.message || '';
                        const esConflictoProfesor = 
                            mensajeError.includes('ya tiene clase') || 
                            mensajeError.includes('ya está asignado') ||
                            mensajeError.includes('ya asignado');
                            
                        // Si es conflicto de profesor en otra clase o si tenemos datos de la clase conflictiva
                        if (esConflictoProfesor || (conflictoData.conflict_type === 'profesor_asignado' && conflictoData.conflicting_class)) {
                            // Datos para el modal de unir clases
                            console.log('[Mover] Detectado conflicto de profesor ya asignado. Mostrando modal unir clases.');
                            
                            // Obtener info de la clase conflictiva (si está disponible)
                            const claseConflicto = conflictoData.conflicting_class || {};
                            console.log('[Mover] Datos de clase conflictiva:', claseConflicto);
                            
                            // Extraer información de la clase conflictiva del mensaje si está disponible
                            const mensaje = conflictoData.message || '';
                            let claseConflictoNombre = 'Otra clase';
                            let asignaturaConflictoNombre = asignaturasData[asignaturaId]?.nombre || 'Misma asignatura';
                            
                            // Intentar extraer el nombre de la clase del mensaje
                            if (mensaje.includes('Sección')) {
                                claseConflictoNombre = mensaje.split('Sección')[1].trim();
                            } else if (mensaje.includes('clase')) {
                                const match = mensaje.match(/clase\s+([^,]+)/);
                                if (match) claseConflictoNombre = match[1].trim();
                            }
                            
                            // Intentar extraer el nombre de la asignatura del mensaje
                            if (mensaje.includes('asignatura')) {
                                const match = mensaje.match(/asignatura\s+([^,]+)/);
                                if (match) asignaturaConflictoNombre = match[1].trim();
                            }
                            
                            // Asegurarnos de que tenemos todos los datos necesarios
                            if (!currentClaseId || !profesorId || !asignaturaId || !destino_dia || !destino_hora) {
                                console.error("[Mover] Faltan datos obligatorios para unir clases:", {
                                    currentClaseId,
                                    profesorId,
                                    asignaturaId,
                                    destino_dia,
                                    destino_hora
                                });
                                return mostrarAlerta('Error: Faltan datos necesarios para unir las clases.', 'danger');
                            }
                            
                            window.unionClasesData = {
                                dia: destino_dia,
                                hora: destino_hora,
                                asignatura_actual_id: asignaturaId,
                                asignatura_actual_nombre: asignaturasData[asignaturaId]?.nombre || 'No disponible',
                                clase_actual_id: currentClaseId,
                                clase_actual_nombre: '{{ clase.nombre }}',
                                profesor_id: profesorId,
                                profesor_nombre: profesoresData[profesorId]?.nombre || 'No disponible',
                                clase_existente_id: claseConflicto.clase_id || 0,
                                clase_existente_nombre: claseConflictoNombre,
                                asignatura_existente_id: claseConflicto.asignatura_id || asignaturaId,
                                asignatura_existente_nombre: asignaturaConflictoNombre
                            };
                            
                            // Verificar que todos los datos requeridos están presentes
                            const datosRequeridos = {
                                clase_actual_id: window.unionClasesData.clase_actual_id,
                                profesor_id: window.unionClasesData.profesor_id,
                                asignatura_actual_id: window.unionClasesData.asignatura_actual_id,
                                dia: window.unionClasesData.dia,
                                hora: window.unionClasesData.hora
                            };
                            
                            const datosFaltantes = Object.entries(datosRequeridos)
                                .filter(([key, value]) => !value)
                                .map(([key]) => key);
                                
                            if (datosFaltantes.length > 0) {
                                console.error("[Mover] Datos faltantes para unir clases:", datosFaltantes);
                                return mostrarAlerta(`Error: Faltan los siguientes datos: ${datosFaltantes.join(', ')}`, "danger");
                            }
                            
                            // Guardar datos de origen para cuando se confirme la unión
                            window.origenMovimiento = {
                                dia: origen_dia,
                                hora: origen_hora
                            };
                            
                            // Mostrar modal de unir clases
                            mostrarModalUnirClases();
                            return Promise.reject(new Error("Conflicto detectado")); // Detener la ejecución
                        } else {
                            // Otro tipo de conflicto, mostrar mensaje de error normal
                            mostrarAlerta(`Conflicto al mover: ${conflictoData.message}`, 'danger');
                            return Promise.reject(new Error("Conflicto detectado")); // Detener la ejecución
                        }
                    }
                    // Si no hay conflicto, proceder a llamar a la API de mover
                    console.log("[Mover] No hay conflicto en destino, llamando a API /schedules/move_class...");
                    return fetch('/schedules/move_class', {
                method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
                        body: JSON.stringify({ 
                            clase_id: currentClaseId, 
                            origen_dia, origen_hora, 
                            destino_dia, destino_hora 
                        })
                    });
                })
                .then(response => {
                     if (!response.ok) { throw new Error(`Error del servidor: ${response.status}`); }
                     return response.json();
                 })
            .then(data => {
                    console.log("[Mover] Respuesta de API /schedules/move_class:", data);
                if (data.success) {
                        actualizarUIAlMover(origen_dia, origen_hora, destino_dia, destino_hora);
                        mostrarAlerta('Clase movida con éxito', 'success');
                } else {
                        mostrarAlerta(`Error al mover: ${data.message || 'Error desconocido'}`, 'danger');
                }
            })
            .catch(error => {
                    if (error.message !== "Conflicto detectado") { // Evitar doble alerta
                         console.error('[Mover] Error:', error);
                         mostrarAlerta(`Error al mover la clase: ${error.message}`, 'danger');
                    }
                });
        }
        
        function actualizarUIAlMover(origen_dia, origen_hora, destino_dia, destino_hora) {
             console.log("[UI Mover] Actualizando interfaz...");
            const origenCelda = document.querySelector(`.celda-horario[data-dia="${origen_dia}"][data-hora="${origen_hora}"]`);
            const destinoCelda = document.querySelector(`.celda-horario[data-dia="${destino_dia}"][data-hora="${destino_hora}"]`);
            if (!origenCelda || !destinoCelda) return;

            const bloque = origenCelda.querySelector('.asignatura-bloque');
            if (bloque) {
                 // Mover el bloque al destino
                 destinoCelda.innerHTML = ''; // Limpiar destino por si acaso
                 destinoCelda.appendChild(bloque.cloneNode(true)); // Clonar para mantener listeners?
                 destinoCelda.classList.remove('celda-vacia');
                 destinoCelda.classList.add('celda-con-clase');
                 destinoCelda.dataset.asignaturaId = origenCelda.dataset.asignaturaId;
                 destinoCelda.dataset.profesorId = origenCelda.dataset.profesorId;
                 // Re-añadir listener de drag al nuevo bloque clonado
                 destinoCelda.querySelector('.asignatura-bloque')?.addEventListener('dragstart', drag);
            } else {
                 console.warn("[UI Mover] No se encontró bloque en origen para mover.");
             }

            // Limpiar celda origen
            origenCelda.innerHTML = '';
            origenCelda.classList.remove('celda-con-clase');
            origenCelda.classList.add('celda-vacia');
            origenCelda.removeAttribute('data-asignatura-id');
            origenCelda.removeAttribute('data-profesor-id');
             console.log("[UI Mover] Interfaz actualizada.");
        }
        
        function eliminarClaseEnServidor(dia, hora) {
            console.log(`[API Eliminar] Eliminando: dia=${dia}, hora=${hora}`);
            return fetch('/schedules/delete_by_position', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
                body: JSON.stringify({ clase_id: currentClaseId, dia, hora })
            }).then(response => response.json());
        }
        
        function eliminarAsignacion() {
            if (!currentDia || !currentHora) return;
            console.log(`[Eliminar] Solicitando eliminar ${currentDia} ${currentHora}° hora`);
            if (confirm(`¿Estás seguro de eliminar la asignación del ${capitalize(currentDia)} a la ${currentHora}° hora?`)) {
                eliminarClaseEnServidor(currentDia, currentHora)
            .then(data => {
                        console.log("[Eliminar] Respuesta del servidor:", data);
                if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('asignarModal')).hide();
                            actualizarCelda(currentDia, currentHora, null, null); // Llamar a actualizar para limpiar la celda
                            mostrarAlerta('Asignación eliminada con éxito', 'success');
                } else {
                            mostrarAlerta(`Error al eliminar: ${data.message || 'Error desconocido'}`, 'danger');
                }
            })
            .catch(error => {
                        console.error('[Eliminar] Error:', error);
                        mostrarAlerta(`Error al eliminar la asignación: ${error.message}`, 'danger');
                    });
            }
        }
        
        function guardarAsignacion() {
            console.log("[Guardar] Iniciando guardado desde modal...");
            if (!selectedAsignaturaId || !selectedProfesorId) {
                mostrarAlerta('Debes seleccionar asignatura y profesor', 'warning');
                return;
            }
            
            const btnGuardar = document.getElementById('btn-guardar');
            const spinner = document.getElementById('spinnerGuardar');
            btnGuardar.disabled = true;
            spinner.classList.remove('d-none');
            document.getElementById('modal-error-container').innerHTML = ''; // Limpiar errores previos del modal

            // Proceder directamente con el guardado (la verificación ya se hizo antes)
            const ajustar = document.getElementById('ajustar-otras-clases')?.checked || false;
            
            actualizarClaseEnServidor(selectedAsignaturaId, selectedProfesorId, currentDia, currentHora, ajustar)
            .then(data => {
                    console.log("[Guardar] Respuesta de API /schedules/update:", data);
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('asignarModal')).hide();
                        actualizarCelda(currentDia, currentHora, selectedAsignaturaId, selectedProfesorId);
                        
                        if (data.adjusted_cells && data.adjusted_cells.length > 0) {
                            data.adjusted_cells.forEach(cell => {
                                actualizarCelda(cell.dia, cell.hora, cell.asignatura_id, cell.profesor_id);
                            });
                            mostrarAlerta('Se han ajustado otras celdas con la misma asignatura', 'info');
                        }
                        mostrarAlerta('Asignación guardada con éxito', 'success');
                } else {
                        mostrarAlertaEnModal(`Error al guardar: ${data.message || 'Error desconocido'}`, 'danger');
                        btnGuardar.disabled = false;
                }
            })
            .catch(error => {
                    console.error('[Guardar] Error:', error);
                    mostrarAlertaEnModal(`Error al guardar la asignación: ${error.message}`, 'danger');
                    btnGuardar.disabled = false;
                })
                .finally(() => {
                    spinner.classList.add('d-none');
                });
        }
        
        function confirmarLimpiarTodo() {
            console.log('[Limpiar Todo] Confirmando...');
            if (confirm('¿Estás seguro de limpiar todo el horario para esta clase? Esta acción no se puede deshacer.')) {
                console.log('[Limpiar Todo] Confirmado, llamando a API...');
                fetch(`/schedules/clear_all/${currentClaseId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() }, // Añadir CSRF si es necesario
                    body: JSON.stringify({})
                })
                .then(response => {
                     if (!response.ok) { throw new Error(`Error del servidor: ${response.status}`); }
                     return response.json();
                 })
                .then(data => {
                    console.log("[Limpiar Todo] Respuesta del servidor:", data);
                    if (data.success) {
                        // Limpiar UI
                        document.querySelectorAll('.celda-con-clase').forEach(celda => {
                            actualizarCelda(celda.dataset.dia, celda.dataset.hora, null, null);
                        });
                        mostrarAlerta('Horario limpiado con éxito', 'success');
                    } else {
                        mostrarAlerta(`Error al limpiar: ${data.message || 'Error desconocido'}`, 'danger');
                    }
                })
                .catch(error => {
                    console.error('[Limpiar Todo] Error:', error);
                    mostrarAlerta(`Error al limpiar el horario: ${error.message}`, 'danger');
                });
            }
        }
        
        function confirmarGenerarAutomatico() {
            console.log('[Generar Auto] Confirmando...');
            if (confirm('¿Generar horario automáticamente? Esto intentará completar los huecos y podría sobrescribir asignaciones existentes si hay conflictos irresolubles.')) {
                // Idealmente, esto llamaría a una API que devuelve el horario generado
                // Por ahora, redirigimos a la ruta que procesa el POST
                console.log('[Generar Auto] Redirigiendo para generación POST...');
                 // Mostrar un spinner o mensaje de carga aquí sería bueno
                 mostrarAlerta("Iniciando generación automática... por favor espere.", "info");
                 // Usar un formulario oculto para enviar POST o redirigir si la ruta GET maneja POST
                 // Si la ruta /generate/<id> maneja POST:
                 const form = document.createElement('form');
                 form.method = 'POST';
                 form.action = `/schedules/generate/${currentClaseId}`;
                 // Añadir CSRF token si es necesario
                 const csrfInput = document.createElement('input');
                 csrfInput.type = 'hidden';
                 csrfInput.name = 'csrf_token'; // Ajustar si el nombre es diferente
                 csrfInput.value = getCsrfToken(); 
                 form.appendChild(csrfInput);
                 document.body.appendChild(form);
                 form.submit();
                 
                 // Si prefieres redirigir al GET y que ese maneje el POST:
                 // window.location.href = `/schedules/generate/${currentClaseId}`;
            }
        }
        
        function actualizarCelda(dia, hora, asignaturaId, profesorId) {
             console.log(`[UI Actualizar Celda] Actualizando ${dia} ${hora}° hora. Asig=${asignaturaId}, Prof=${profesorId}`);
            const celda = document.querySelector(`.celda-horario[data-dia="${dia}"][data-hora="${hora}"]`);
            if (!celda) {
                console.error(`[UI Actualizar Celda] No se encontró celda para ${dia} ${hora}`);
                return;
            }
            
            // Limpiar contenido anterior
            celda.innerHTML = ''; 

            if (asignaturaId && profesorId) {
                // Si hay datos, crear el bloque
            celda.classList.remove('celda-vacia');
            celda.classList.add('celda-con-clase');
                celda.dataset.asignaturaId = asignaturaId;
                celda.dataset.profesorId = profesorId;
                
                try {
                    const asignatura = asignaturasData[asignaturaId];
                    const profesor = profesoresData[profesorId];
                    
                    if (!asignatura || !profesor) throw new Error("Datos de asignatura o profesor no encontrados");

                    const bloqueHTML = `
                        <div class="asignatura-bloque" 
                             data-color="${asignatura.color}"
                             style="background-color: ${asignatura.color}"
                             draggable="true"
                             ondragstart="drag(event)"
                             data-asignatura-id="${asignaturaId}"
                             data-profesor-id="${profesorId}"
                             title="${asignatura.nombre} - ${profesor.nombre}">
                    <div class="asignatura-nombre">
                        ${asignatura.icono ? `<i class="fas ${asignatura.icono} me-1"></i>` : ''}
                        ${asignatura.nombre}
                    </div>
                    <div class="profesor-nombre">
                        ${profesor.nombre}
                    </div>
                </div>
            `;
                    celda.innerHTML = bloqueHTML;
                    // Re-añadir listener de drag al nuevo bloque
                    celda.querySelector('.asignatura-bloque')?.addEventListener('dragstart', drag);
                    
                } catch (error) {
                    console.error(`[UI Actualizar Celda] Error creando bloque: ${error.message}`);
                    celda.innerHTML = '<span class="text-danger small">Error</span>'; // Mostrar error en celda
                }
            } else {
                // Si no hay datos, limpiar la celda
            celda.classList.remove('celda-con-clase');
            celda.classList.add('celda-vacia');
                celda.removeAttribute('data-asignatura-id');
                celda.removeAttribute('data-profesor-id');
            }
        }
        
        // Llama a la API /schedules/update
        function actualizarClaseEnServidor(asignaturaId, profesorId, dia, hora, ajustarOtrasCeldas) {
             console.log(`[API Update] Guardando: Asig=${asignaturaId}, Prof=${profesorId}, Dia=${dia}, Hora=${hora}, Ajustar=${ajustarOtrasCeldas}`);
            return fetch('/schedules/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    clase_id: currentClaseId,
                    asignatura_id: asignaturaId,
                    profesor_id: profesorId,
                    dia: dia,
                    hora: hora,
                    ajustar_otras_celdas: ajustarOtrasCeldas
                })
            })
            .then(response => {
                 if (!response.ok) { 
                      throw new Error(`Error del servidor: ${response.status}`); 
                 }
                 return response.json();
             });
        }
        
        function openModalForNewAsignatura(asignaturaId, dia, hora) {
             console.log(`[Modal Nuevo] Abriendo para nueva asignatura ${asignaturaId} en ${dia} ${hora}° hora`);
            currentDia = dia;
            currentHora = hora;
            
            document.getElementById('modal-dia').textContent = capitalize(currentDia);
            document.getElementById('modal-hora').textContent = currentHora + '° hora';
            
            selectedAsignaturaId = asignaturaId;
            selectedProfesorId = null; 
            
            document.querySelectorAll('.subject-option').forEach(option => {
                option.classList.toggle('selected', option.dataset.id === asignaturaId);
            });
            
            updateProfesoresList();
            verificarConflictos(); // Verificar inmediatamente
            
            // Habilitar/Deshabilitar botón de eliminar (no aplica para nuevo)
             document.getElementById('btn-eliminar').style.display = 'none'; 
            
            const asignarModal = new bootstrap.Modal(document.getElementById('asignarModal'));
            asignarModal.show();
        }
        
        function openModal(event) {
            const celda = event.currentTarget;
            console.log(`[Modal Editar/Nuevo] Abriendo para celda ${celda.dataset.dia} ${celda.dataset.hora}° hora`);
            currentDia = celda.dataset.dia;
            currentHora = celda.dataset.hora;
            
            document.getElementById('modal-dia').textContent = capitalize(currentDia);
            document.getElementById('modal-hora').textContent = currentHora + '° hora';
            
            const asignaturaIdActual = celda.dataset.asignaturaId || null;
            const profesorIdActual = celda.dataset.profesorId || null;
            
            selectedAsignaturaId = asignaturaIdActual;
            selectedProfesorId = profesorIdActual;
            
            console.log(`[Modal Editar/Nuevo] Estado inicial: Asig=${selectedAsignaturaId}, Prof=${selectedProfesorId}`);

            document.querySelectorAll('.subject-option').forEach(option => {
                option.classList.toggle('selected', selectedAsignaturaId && option.dataset.id === selectedAsignaturaId);
            });
            
            updateProfesoresList(); // Llama a verificarConflictos dentro

             // Habilitar/Deshabilitar botón de eliminar
             document.getElementById('btn-eliminar').style.display = asignaturaIdActual ? 'inline-block' : 'none'; 
            
            const asignarModal = new bootstrap.Modal(document.getElementById('asignarModal'));
            asignarModal.show();
        }
        
        function selectAsignatura(event) {
            const option = event.currentTarget;
            const nuevoAsignaturaId = option.dataset.id;
             console.log(`[Modal Select Asig] Seleccionada asignatura ID: ${nuevoAsignaturaId}`);

            document.querySelectorAll('.subject-option').forEach(opt => opt.classList.remove('selected'));
            option.classList.add('selected');
            
            selectedAsignaturaId = nuevoAsignaturaId;
            selectedProfesorId = null; // Resetear profesor al cambiar asignatura
            
            updateProfesoresList(); // Llama a verificarConflictos dentro
        }
        
        function updateProfesoresList() {
            const profesoresList = document.getElementById('profesores-list');
            profesoresList.innerHTML = '';
             console.log(`[Modal Update Prof] Actualizando lista para Asig ID: ${selectedAsignaturaId}`);
            
            if (!selectedAsignaturaId) {
                profesoresList.innerHTML = '<div class="alert alert-light border small">Seleccione una asignatura.</div>';
                 verificarConflictos(); // Llamar para limpiar/resetear estado de conflicto y botón guardar
                return;
            }
            
            const profesoresIds = asignaturasData[selectedAsignaturaId]?.profesores || [];
            console.log(`[Modal Update Prof] IDs de profesores encontrados:`, profesoresIds);
            
            if (profesoresIds.length === 0) {
                profesoresList.innerHTML = '<div class="alert alert-warning small">No hay profesores asignados a esta asignatura.</div>';
                 verificarConflictos(); // Llamar para limpiar/resetear estado de conflicto y botón guardar
                return;
            }
            
            profesoresIds.forEach(profesorId => {
                const profesor = profesoresData[profesorId];
                if (!profesor) return;
                
                const isSelected = profesorId == selectedProfesorId;
                const aProfesor = document.createElement('a');
                aProfesor.href = "#";
                aProfesor.className = `list-group-item list-group-item-action profesor-option ${isSelected ? 'selected' : ''}`;
                aProfesor.dataset.id = profesorId;
                aProfesor.textContent = profesor.nombre;
                
                aProfesor.addEventListener('click', function(e) {
                    e.preventDefault();
                    document.querySelectorAll('.profesor-option').forEach(p => p.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedProfesorId = this.dataset.id;
                     console.log(`[Modal Select Prof] Seleccionado profesor ID: ${selectedProfesorId}`);
                    verificarConflictos(); // Verificar al seleccionar profesor
                });
                profesoresList.appendChild(aProfesor);
            });

             // Si había un profesor preseleccionado (al editar), verificar conflictos
             if (selectedProfesorId) {
                 verificarConflictos();
             } else {
                 // Si no hay profesor seleccionado, limpiar conflictos y deshabilitar guardar
                 limpiarYDeshabilitarGuardar();
             }
        }

        // Llama a la API para verificar conflictos
        function checkConflictsAPI(profesorId, dia, hora, claseId) {
             console.log(`[API Check Conflicts] Verificando: Prof=${profesorId}, Dia=${dia}, Hora=${hora}, ClaseActual=${claseId}`);
             if (!profesorId || !dia || !hora) {
                 console.warn("[API Check Conflicts] Datos insuficientes para verificar.");
                 // Devolver una promesa resuelta como si no hubiera conflicto para no bloquear
                 return Promise.resolve({ conflict: false, message: 'Datos insuficientes para verificar' }); 
             }
             // Asegurarse de que la hora es un número para la URL (si la API espera número)
             const horaNum = parseInt(hora); // Asume que `hora` es algo como '1', '2', etc.
             if (isNaN(horaNum)) {
                 console.error(`[API Check Conflicts] Formato de hora inválido: ${hora}`);
                 return Promise.resolve({ conflict: true, message: `Formato de hora inválido: ${hora}`});
             }
             
             const url = `/schedules/check_conflicts?profesor_id=${profesorId}&dia=${dia}&hora=${horaNum}&clase_id=${claseId}`;
             return fetch(url)
                 .then(response => {
                     if (!response.ok) { throw new Error(`Error ${response.status} verificando conflictos`); }
                     return response.json();
                 })
                 .catch(error => {
                     console.error("[API Check Conflicts] Error en fetch:", error);
                     // Devolver un objeto de conflicto para manejarlo consistentemente
                     return { conflict: true, message: `Error al conectar: ${error.message}` }; 
                 });
         }
        
        // Función para verificar conflictos (independiente, no bloquea la edición)
        function verificarConflictos() {
            const conflictoDiv = document.getElementById('conflicto-info');
            const btnGuardar = document.getElementById('btn-guardar');
            conflictoDiv.innerHTML = '<span class="text-muted small"><i class="fas fa-spinner fa-spin me-1"></i>Verificando...</span>'; // Mensaje con spinner
            
            if (!selectedProfesorId || !selectedAsignaturaId) {
                 console.log("[Check Conflicts UI] Faltan asignatura o profesor.");
                 limpiarYDeshabilitarGuardar();
                 return;
             }
            
            // Asegurarse de que currentHora es el número correcto
            const horaNumParaCheck = parseInt(currentHora); 
            if (isNaN(horaNumParaCheck)) {
                console.error("[Check Conflicts UI] Hora actual inválida:", currentHora);
                mostrarAlertaEnModal("Error interno: Hora inválida.", "danger");
                limpiarYDeshabilitarGuardar();
                return;
            }

            checkConflictsAPI(selectedProfesorId, currentDia, horaNumParaCheck, currentClaseId)
                .then(data => {
                    console.log("[Check Conflicts UI] Respuesta de API:", data);
                    if (data.conflict) {
                        // Comprobar si el mensaje de error contiene alguna indicación de que el profesor está asignado en otra clase
                        const mensajeError = data.message || '';
                        const esConflictoProfesor = 
                            mensajeError.includes('ya tiene clase') || 
                            mensajeError.includes('ya está asignado') ||
                            mensajeError.includes('ya asignado');
                            
                        // Si es conflicto de profesor en otra clase o si tenemos datos de la clase conflictiva
                        if (esConflictoProfesor || (data.conflict_type === 'profesor_asignado' && data.conflicting_class)) {
                            console.log('[Check Conflicts UI] Detectado conflicto de profesor ya asignado.');
                            // Obtener info de la clase conflictiva (si está disponible)
                            const claseConflicto = data.conflicting_class || {};
                            
                            // Preparar datos para el botón de unir clases
                            window.unionClasesData = {
                                dia: currentDia,
                                hora: currentHora,
                                asignatura_actual_id: selectedAsignaturaId,
                                asignatura_actual_nombre: asignaturasData[selectedAsignaturaId]?.nombre || 'No disponible',
                                clase_actual_id: currentClaseId,
                                clase_actual_nombre: '{{ clase.nombre }}',
                                profesor_id: selectedProfesorId,
                                profesor_nombre: profesoresData[selectedProfesorId]?.nombre || 'No disponible',
                                clase_existente_id: data.conflicting_class.clase_id,
                                clase_existente_nombre: data.conflicting_class.clase_nombre || 'Clase desconocida',
                                asignatura_existente_id: data.conflicting_class.asignatura_id,
                                asignatura_existente_nombre: data.conflicting_class.asignatura_nombre || 'No disponible'
                            };
                            
                            // Agregar botón para unir clases en el modal actual
                            const actionBtn = `<button type="button" class="btn btn-sm btn-warning mt-2" onclick="mostrarModalUnirClases()">
                                <i class="fas fa-object-group me-1"></i> Unir Clases
                            </button>`;
                            
                            conflictoDiv.innerHTML += actionBtn;
                        } else {
                            // Otro tipo de conflicto, mostrar mensaje de error normal
                            mostrarAlertaEnModal(`Conflicto: ${data.message}`, 'danger');
                            // Permitir guardar de todos modos, es responsabilidad del usuario
                            btnGuardar.disabled = false;
                        }
                    } else {
                        mostrarAlertaEnModal('Profesor disponible y sin conflictos detectados.', 'success');
                        btnGuardar.disabled = false; // Habilitar siempre
                    }
                })
                .catch(error => {
                     console.error("[Check Conflicts UI] Error inesperado en la verificación:", error);
                     mostrarAlertaEnModal(`Error al verificar disponibilidad: ${error.message}`, 'warning');
                     // Permitir guardar de todos modos
                     btnGuardar.disabled = false;
                 });
        }

        // Función para mostrar el modal de unir clases
        function mostrarModalUnirClases() {
            if (!window.unionClasesData) {
                console.error("[Unir Clases] No hay datos para mostrar el modal");
                mostrarAlerta("Error: No hay datos para mostrar el modal de unir clases", "danger");
                return;
            }
            
            const data = window.unionClasesData;
            
            // Verificar que tenemos todos los datos necesarios
            const datosRequeridos = {
                clase_actual_id: data.clase_actual_id,
                profesor_id: data.profesor_id,
                asignatura_actual_id: data.asignatura_actual_id,
                dia: data.dia,
                hora: data.hora
            };
            
            const datosFaltantes = Object.entries(datosRequeridos)
                .filter(([key, value]) => !value)
                .map(([key]) => key);
                
            if (datosFaltantes.length > 0) {
                console.error("[Unir Clases] Datos faltantes para mostrar modal:", datosFaltantes);
                mostrarAlerta(`Error: Faltan los siguientes datos: ${datosFaltantes.join(', ')}`, "danger");
                return;
            }
            
            // Obtener el modal y verificar que existe
            const modalElement = document.getElementById('unirClasesModal');
            if (!modalElement) {
                console.error("[Unir Clases] No se encontró el elemento del modal");
                mostrarAlerta("Error: No se pudo encontrar el modal de unir clases", "danger");
                return;
            }
            
            // Actualizar datos en el modal con verificaciones de null
            const elements = {
                'unir-clases-actual': data.clase_actual_nombre || 'Clase actual',
                'unir-clases-asignatura-actual': data.asignatura_actual_nombre || 'Asignatura actual',
                'unir-clases-existente': data.clase_existente_nombre || 'Otra clase',
                'unir-clases-asignatura-existente': data.asignatura_existente_nombre || 'Misma asignatura',
                'unir-clases-mensaje': `El profesor ${data.profesor_nombre || 'el profesor'} ya está asignado a la clase ${data.clase_existente_nombre || 'otra clase'} en este horario (${capitalize(data.dia)}, ${data.hora}° hora).`
            };
            
            // Actualizar cada elemento solo si existe
            for (const [id, content] of Object.entries(elements)) {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = content;
                } else {
                    console.warn(`[Unir Clases] Elemento con ID ${id} no encontrado en el DOM`);
                }
            }
            
            // Configurar botón de confirmar
            const btnConfirmarUnir = document.getElementById('btn-confirmar-unir');
            const spinnerUnir = document.getElementById('spinnerUnir');
            
            if (!btnConfirmarUnir || !spinnerUnir) {
                console.error("[Unir Clases] Elementos del botón de confirmar no encontrados");
                mostrarAlerta("Error: No se pudo encontrar el botón de confirmar", "danger");
                return;
            }
            
            // Eliminar listener previo si existe
            btnConfirmarUnir.onclick = null;
            
            // Agregar nuevo listener
            btnConfirmarUnir.addEventListener('click', confirmarUnirClases);
            
            // Mostrar modal
            const unirClasesModal = new bootstrap.Modal(modalElement);
            unirClasesModal.show();
        }
        
        // Función para confirmar unión de clases
        function confirmarUnirClases() {
            if (!window.unionClasesData) {
                console.error("[Unir Clases] No hay datos para unir clases");
                mostrarAlerta("Error: No hay datos para unir las clases", "danger");
                return;
            }
            
            const data = window.unionClasesData;
            console.log("[Unir Clases] Datos disponibles:", data);
            
            // Verificar datos mínimos requeridos
            const datosRequeridos = {
                clase_actual_id: data.clase_actual_id,
                profesor_id: data.profesor_id,
                asignatura_actual_id: data.asignatura_actual_id,
                dia: data.dia,
                hora: data.hora
            };
            
            const datosFaltantes = Object.entries(datosRequeridos)
                .filter(([key, value]) => !value)
                .map(([key]) => key);
                
            if (datosFaltantes.length > 0) {
                console.error("[Unir Clases] Datos faltantes:", datosFaltantes);
                mostrarAlerta(`Error: Faltan los siguientes datos: ${datosFaltantes.join(', ')}`, "danger");
                return;
            }
            
            const btnConfirmarUnir = document.getElementById('btn-confirmar-unir');
            const spinnerUnir = document.getElementById('spinnerUnir');
            
            if (!btnConfirmarUnir || !spinnerUnir) {
                console.error("[Unir Clases] Elementos del botón de confirmar no encontrados");
                mostrarAlerta("Error: No se pudo encontrar el botón de confirmar", "danger");
                return;
            }
            
            // Deshabilitar botón y mostrar spinner
            btnConfirmarUnir.disabled = true;
            spinnerUnir.classList.remove('d-none');
            
            // Preparar datos para la API
            const apiData = {
                clase_actual_id: data.clase_actual_id,
                profesor_id: data.profesor_id,
                asignatura_actual_id: data.asignatura_actual_id,
                dia: data.dia,
                hora: data.hora,
                clase_existente_id: data.clase_existente_id || 0,
                asignatura_existente_id: data.asignatura_existente_id || data.asignatura_actual_id
            };
            
            console.log("[Unir Clases] Enviando datos a API:", apiData);
            
            // Llamar a la API para unir clases
            fetch('/schedules/unir_clases', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
                body: JSON.stringify(apiData)
            })
            .then(response => {
                if (!response.ok) { 
                    throw new Error(`Error del servidor: ${response.status}`); 
                }
                return response.json();
            })
            .then(respData => {
                if (respData.success) {
                    // Cerrar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('unirClasesModal'));
                    if (modal) modal.hide();
                    
                    // Verificar si esta unión viene de un movimiento de clase
                    if (window.origenMovimiento) {
                        // Si viene de un movimiento, actualizar la interfaz para reflejar el movimiento
                        actualizarUIAlMover(
                            window.origenMovimiento.dia, 
                            window.origenMovimiento.hora, 
                            data.dia, 
                            data.hora
                        );
                        // Limpiar datos de origen
                        window.origenMovimiento = null;
                    } else {
                        // Si no viene de un movimiento, solo actualizar la celda destino
                        actualizarCelda(data.dia, data.hora, data.asignatura_actual_id, data.profesor_id);
                    }
                    
                    // Mostrar mensaje de éxito
                    mostrarAlerta('Clases unidas correctamente', 'success');
                } else {
                    throw new Error(respData.message || 'Error al unir clases');
                }
            })
            .catch(error => {
                console.error('[Unir Clases] Error:', error);
                mostrarAlerta(`Error al unir clases: ${error.message}`, 'danger');
            })
            .finally(() => {
                // Restaurar botón
                if (btnConfirmarUnir) btnConfirmarUnir.disabled = false;
                if (spinnerUnir) spinnerUnir.classList.add('d-none');
            });
        }

        function limpiarYDeshabilitarGuardar() {
             const conflictoDiv = document.getElementById('conflicto-info');
             const btnGuardar = document.getElementById('btn-guardar');
             conflictoDiv.innerHTML = '<span class="text-muted small">Seleccione asignatura y profesor.</span>';
             btnGuardar.disabled = true;
         }

        function mostrarAlertaEnModal(mensaje, tipo = 'info') {
             const conflictoDiv = document.getElementById('conflicto-info');
             conflictoDiv.innerHTML = `
                 <div class="alert alert-${tipo} alert-dismissible fade show small py-1" role="alert">
                     ${tipo === 'danger' ? '<i class="fas fa-exclamation-triangle me-1"></i>' : ''}
                     ${tipo === 'success' ? '<i class="fas fa-check-circle me-1"></i>' : ''}
                ${mensaje}
                     <button type="button" class="btn-close py-1 px-2" data-bs-dismiss="alert" aria-label="Close" style="font-size: 0.7rem;"></button>
                 </div>
             `;
             console.log(`[Modal Alert ${tipo}]: ${mensaje}`);
         }
        
        // Mostrar alertas generales
        function mostrarAlerta(mensaje, tipo) {
            console.log(`[Alerta General ${tipo}]: ${mensaje}`);
            
            // Intentar encontrar un contenedor adecuado para la alerta
            let alertPlaceholder = document.querySelector('.container-fluid');
            if (!alertPlaceholder) {
                alertPlaceholder = document.querySelector('body');
                if (!alertPlaceholder) {
                    console.error("[Alerta] No se pudo encontrar un contenedor para la alerta");
                    return;
                }
            }

            const wrapper = document.createElement('div');
            wrapper.innerHTML = [
                `<div class="alert alert-${tipo} alert-dismissible fade show" role="alert">`,
                `   <div>${mensaje}</div>`,
                '   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>',
                '</div>'
            ].join('');

            // Insertar la alerta de manera segura
            try {
                alertPlaceholder.insertBefore(wrapper.firstChild, alertPlaceholder.firstChild);
            } catch (error) {
                console.error("[Alerta] Error al insertar la alerta:", error);
                return;
            }
            
            // Auto-eliminar después de 5 segundos
            const alertElement = wrapper.firstChild;
            if (alertElement) {
                setTimeout(() => {
                    if (alertElement.parentNode) {
                        alertElement.classList.remove('show');
                        alertElement.addEventListener('transitionend', () => {
                            if (alertElement.parentNode) {
                                alertElement.remove();
                            }
                        });
                    }
                }, 5000);
            }
        }
        
        function capitalize(string) {
             if (!string) return '';
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        function getCsrfToken() {
            return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
        }

        // --- Inicialización --- 
        console.log('[Init] Editor de horarios listo.');

        function handleDrop(event) {
            event.preventDefault();
            const targetCell = event.target.closest('.hora-cell');
            if (!targetCell) return;

            const dia = targetCell.dataset.dia;
            const hora = targetCell.dataset.hora;
            const asignaturaId = event.dataTransfer.getData('asignaturaId');
            const profesorId = event.dataTransfer.getData('profesorId');
            const unidoConClaseId = event.dataTransfer.getData('unidoConClaseId'); // Nuevo dato

            // Verificar si ya existe una asignatura en esta celda
            const existingBlock = targetCell.querySelector('.asignatura-bloque');
            if (existingBlock) {
                // Si existe, significa que estamos uniendo clases
                const existingAsignaturaId = existingBlock.dataset.asignaturaId;
                if (existingAsignaturaId === asignaturaId) {
                    // Solo permitir unir si es la misma asignatura
                    const data = {
                        clase_id: currentClaseId,
                        dia: dia,
                        hora: hora,
                        asignatura_id: asignaturaId,
                        profesor_id: profesorId,
                        unido_con_clase_id: existingBlock.dataset.claseId // Usar la clase existente
                    };

                    fetch('/admin/horarios/guardar_bloque', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Actualizar la interfaz
                            existingBlock.dataset.unidoConClaseId = currentClaseId;
                            existingBlock.classList.add('unido');
                            mostrarAlerta('Clases unidas correctamente', 'success');
                        } else {
                            mostrarAlerta(data.message || 'Error al unir clases', 'danger');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        mostrarAlerta('Error al unir clases', 'danger');
                    });
                } else {
                    mostrarAlerta('Solo se pueden unir clases con la misma asignatura', 'warning');
                }
            } else {
                // Código existente para asignar nueva asignatura
                // ... existing code ...
            }
        }

    });
</script>
{% endblock %} 