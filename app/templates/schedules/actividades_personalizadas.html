{% extends 'base.html' %}

{% block title %}Actividades Personalizadas - Generador de Horarios{% endblock %}

{% block extra_css %}
<style>
    .activity-card {
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .activity-preview {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .activity-icon {
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        color: white;
    }

    .color-preview {
        width: 25px;
        height: 25px;
        border-radius: 50%;
        border: 1px solid #dee2e6;
    }

    .btn-edit, .btn-delete {
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.9rem;
    }

    .btn-edit {
        background-color: #ffc107;
        color: #000;
    }

    .btn-delete {
        background-color: #dc3545;
        color: white;
    }

    .modal-content {
        border-radius: 8px;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .icon-picker {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 10px;
        max-height: 200px;
        overflow-y: auto;
        padding: 10px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
    }

    .icon-option {
        padding: 10px;
        text-align: center;
        cursor: pointer;
        border-radius: 4px;
        transition: background-color 0.2s;
    }

    .icon-option:hover {
        background-color: #f8f9fa;
    }

    .icon-option.selected {
        background-color: #e3f2fd;
    }

    .error-message {
        display: none;
        background-color: #f8d7da;
        color: #721c24;
        padding: 10px;
        margin-bottom: 15px;
        border-radius: 4px;
        border: 1px solid #f5c6cb;
    }

    .alert-success {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px;
        background-color: #d4edda;
        color: #155724;
        border-radius: 4px;
        border: 1px solid #c3e6cb;
        z-index: 1000;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .activity-card {
        display: flex;
        align-items: center;
        padding: 10px;
        margin: 5px;
        border-radius: 4px;
        background-color: #fff;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .activity-icon {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 10px;
    }

    .activity-icon i {
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h2 mb-0">
                <i class="fas fa-palette me-2"></i>Actividades Personalizadas
            </h1>
            <p class="text-muted">Crea y gestiona tus propias actividades especiales.</p>
        </div>
    </div>

    <div class="error-message" id="errorMessage"></div>

    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Nueva Actividad</h5>
                </div>
                <div class="card-body">
                    <form id="activityForm" method="POST">
                        <div class="form-group">
                            <label for="nombre">Nombre</label>
                            <input type="text" class="form-control" id="nombre" name="nombre" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="color">Color</label>
                            <input type="color" class="form-control" id="color" name="color" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Icono (opcional)</label>
                            <div class="icon-picker" id="iconPicker">
                                {% for icon in ['fa-running', 'fa-language', 'fa-school', 'fa-users', 'fa-file-alt', 
                                              'fa-book', 'fa-music', 'fa-paint-brush', 'fa-flask', 'fa-laptop',
                                              'fa-chalkboard', 'fa-graduation-cap', 'fa-microscope', 'fa-calculator',
                                              'fa-globe', 'fa-history', 'fa-atom', 'fa-dna', 'fa-brain', 'fa-heart'] %}
                                <div class="icon-option" data-icon="{{ icon }}">
                                    <i class="fas {{ icon }}"></i>
                                </div>
                                {% endfor %}
                            </div>
                            <input type="hidden" id="icono" name="icono">
                        </div>
                        
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Guardar Actividad
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Mis Actividades</h5>
                </div>
                <div class="card-body">
                    <div id="activitiesList">
                        {% for actividad in actividades %}
                        <div class="activity-card" data-id="{{ actividad.id }}">
                            <div class="activity-preview">
                                <div class="activity-icon" style="background-color: {{ actividad.color }}">
                                    {% if actividad.icono %}
                                    <i class="fas {{ actividad.icono }}"></i>
                                    {% endif %}
                                </div>
                                <span>{{ actividad.nombre }}</span>
                            </div>
                            <div class="activity-actions">
                                <button class="btn btn-edit me-2" onclick="editActivity({{ actividad.id }})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-delete" onclick="deleteActivity({{ actividad.id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para editar actividad -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Actividad</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" id="editId">
                    <div class="form-group">
                        <label for="editNombre">Nombre</label>
                        <input type="text" class="form-control" id="editNombre" required>
                    </div>
                    <div class="form-group">
                        <label for="editColor">Color</label>
                        <input type="color" class="form-control" id="editColor" required>
                    </div>
                    <div class="form-group">
                        <label>Icono</label>
                        <div class="icon-picker" id="editIconPicker"></div>
                        <input type="hidden" id="editIcono">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveEdit()">Guardar Cambios</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('activityForm');
    const modal = document.getElementById('editModal');
    const closeBtn = document.querySelector('.btn-close');
    const cancelBtn = document.querySelector('.btn-secondary');
    const actividadesContainer = document.getElementById('activitiesList');
    const errorMessage = document.getElementById('errorMessage');

    // Función para mostrar mensajes de error
    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
        setTimeout(() => {
            errorMessage.style.display = 'none';
        }, 5000);
    }

    // Función para mostrar mensajes de éxito
    function showSuccess(message) {
        const successMessage = document.createElement('div');
        successMessage.className = 'alert alert-success';
        successMessage.textContent = message;
        document.body.appendChild(successMessage);
        setTimeout(() => {
            successMessage.remove();
        }, 3000);
    }

    // Función para agregar una nueva actividad al contenedor
    function addActividadToContainer(actividad) {
        const actividadElement = document.createElement('div');
        actividadElement.className = 'activity-card';
        actividadElement.setAttribute('data-id', actividad.id);
        
        const icon = document.createElement('div');
        icon.className = 'activity-icon';
        icon.style.backgroundColor = actividad.color;
        
        const iconContent = document.createElement('i');
        iconContent.className = actividad.icono || 'fas fa-calendar';
        
        const name = document.createElement('span');
        name.textContent = actividad.nombre;
        
        icon.appendChild(iconContent);
        actividadElement.appendChild(icon);
        actividadElement.appendChild(name);
        actividadesContainer.appendChild(actividadElement);
    }

    // Icon picker functionality
    const iconOptions = document.querySelectorAll('.icon-option');
    iconOptions.forEach(option => {
        option.addEventListener('click', function() {
            // Remover la clase selected de todas las opciones
            iconOptions.forEach(opt => opt.classList.remove('selected'));
            // Agregar la clase selected a la opción clickeada
            this.classList.add('selected');
            // Actualizar el valor del input hidden con el icono seleccionado
            const iconoInput = document.getElementById('icono');
            iconoInput.value = this.dataset.icon;
            console.log('Icono seleccionado:', iconoInput.value); // Para debugging
        });
    });

    // Asegurarse de que el formulario incluya el icono seleccionado
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        const data = {
            nombre: formData.get('nombre'),
            color: formData.get('color'),
            icono: formData.get('icono')
        };

        console.log('Datos a enviar:', data); // Para debugging

        try {
            const response = await fetch('/schedules/gestionar_actividades_personalizadas', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams(data)
            });

            const result = await response.json();
            console.log('Respuesta del servidor:', result); // Para debugging

            if (result.success) {
                showSuccess(result.message);
                addActividadToContainer(result.actividad);
                form.reset();
                // Limpiar la selección de iconos
                iconOptions.forEach(opt => opt.classList.remove('selected'));
            } else {
                showError(result.message);
            }
        } catch (error) {
            showError('Error al comunicarse con el servidor');
            console.error('Error:', error);
        }
    });

    function editActivity(id) {
        const activity = document.querySelector(`.activity-card[data-id="${id}"]`);
        const nombre = activity.querySelector('.activity-preview span').textContent;
        const color = activity.querySelector('.activity-icon').style.backgroundColor;
        const icono = activity.querySelector('.activity-icon i')?.className.replace('fas ', '');
        
        document.getElementById('editId').value = id;
        document.getElementById('editNombre').value = nombre;
        document.getElementById('editColor').value = rgbToHex(color);
        document.getElementById('editIcono').value = icono || '';
        
        // Update icon picker
        const editIconOptions = document.querySelectorAll('#editIconPicker .icon-option');
        editIconOptions.forEach(option => {
            option.classList.remove('selected');
            if (option.dataset.icon === icono) {
                option.classList.add('selected');
            }
        });
        
        new bootstrap.Modal(document.getElementById('editModal')).show();
    }

    function saveEdit() {
        const id = document.getElementById('editId').value;
        const data = {
            nombre: document.getElementById('editNombre').value,
            color: document.getElementById('editColor').value,
            icono: document.getElementById('editIcono').value
        };
        
        fetch(`{{ url_for("schedules.gestionar_actividad_personalizada", id=0) }}`.replace('0', id), {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess(data.message);
                location.reload();
            } else {
                showError(data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Error al actualizar la actividad');
        });
    }

    function deleteActivity(id) {
        if (confirm('¿Estás seguro de que deseas eliminar esta actividad?')) {
            fetch(`{{ url_for("schedules.gestionar_actividad_personalizada", id=0) }}`.replace('0', id), {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess(data.message);
                    location.reload();
                } else {
                    showError(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError('Error al eliminar la actividad');
            });
        }
    }

    function rgbToHex(rgb) {
        // Convert rgb(r, g, b) to #RRGGBB
        const match = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
        if (!match) return rgb;
        
        function hex(x) {
            return ("0" + parseInt(x).toString(16)).slice(-2);
        }
        
        return "#" + hex(match[1]) + hex(match[2]) + hex(match[3]);
    }
});
</script>
{% endblock %} 